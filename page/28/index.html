<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="o1eiNMhypkcaTCNHyHeoaEJM-2wqU4uSpp7XfdfQglI">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"keleven.me","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="千变万化的是世界">
<meta property="og:type" content="website">
<meta property="og:title" content="Keleven.Me">
<meta property="og:url" content="http://keleven.me/page/28/index.html">
<meta property="og:site_name" content="Keleven.Me">
<meta property="og:description" content="千变万化的是世界">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="K11">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://keleven.me/page/28/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/28/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Keleven.Me</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111519029-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-111519029-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js" defer></script>








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Keleven.Me</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="K11"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">K11</p>
  <div class="site-description" itemprop="description">千变万化的是世界</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">305</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/k11me" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;k11me" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:k11@keleven.me" title="E-Mail → mailto:k11@keleven.me" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/_y.o_o.y_/" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;_y.o_o.y_&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/08/03/1c888c36199a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/08/03/1c888c36199a/" class="post-title-link" itemprop="url">2016年8月3日</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-08-03 15:23:00" itemprop="dateCreated datePublished" datetime="2016-08-03T15:23:00+08:00">2016-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-04 08:35:02" itemprop="dateModified" datetime="2025-10-04T08:35:02+08:00">2025-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Living/" itemprop="url" rel="index"><span itemprop="name">Living</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/08/03/1c888c36199a/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/03/1c888c36199a/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="日期：2016年08月03日"><a href="#日期：2016年08月03日" class="headerlink" title="日期：2016年08月03日"></a>日期：2016年08月03日</h2><h3 id="今日记录"><a href="#今日记录" class="headerlink" title="今日记录"></a>今日记录</h3><p>安装并使用atom，比sublime好用一点。ubuntu下可以输入中文。</p>
<p>有markdown保存为pdf的插件。</p>
<p>完成laravel学习。</p>
<p>花费时间比预计的要长。</p>
<p>截个图吧~</p>
<p><img src="http://i.imgur.com/M4l2d00.png" alt="sp160803_232639"></p>
<h3 id="今日计划完成度"><a href="#今日计划完成度" class="headerlink" title="今日计划完成度"></a>今日计划完成度</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 1. laravel学习完成。</li>
</ul>
<h3 id="3日计划"><a href="#3日计划" class="headerlink" title="3日计划"></a>3日计划</h3><ul>
<li><p><input disabled="" type="checkbox"> 
1. 学习gulp与sass</p>
</li>
<li><p><input disabled="" type="checkbox"> 
2. 学习laravel 服务。</p>
</li>
<li><p><input disabled="" type="checkbox"> 
3. 学习数据结构</p>
</li>
<li><p><input disabled="" type="checkbox"> 
4. 了解HTML5 与 CSS3</p>
</li>
<li><p><input disabled="" type="checkbox"> 
5. bootstrap学习（前端框架）</p>
</li>
<li><p><input disabled="" type="checkbox"> 
6. 设计网站制作进度表</p>
</li>
</ul>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/3db1ab34f96e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/3db1ab34f96e/" class="post-title-link" itemprop="url">laravel 学习指南 第八章 第五节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 18:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T18:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/3db1ab34f96e/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/3db1ab34f96e/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="8-5-序列化"><a href="#8-5-序列化" class="headerlink" title="8.5 序列化"></a>8.5 序列化</h2><h3 id="8-5-1-简介"><a href="#8-5-1-简介" class="headerlink" title="8.5.1 简介"></a>8.5.1 简介</h3><p>当构建 <code>JSON API</code> 时，经常需要转化模型和关联关系为<code>数组</code>或<code>JSON</code>。Eloquent 包含便捷方法实现这些转换，以及控制哪些属性被包含到序列化中。</p>
<hr>
<h3 id="8-5-2-基本使用"><a href="#8-5-2-基本使用" class="headerlink" title="8.5.2 基本使用"></a>8.5.2 基本使用</h3><h4 id="8-5-2-1-转化模型为数组"><a href="#8-5-2-1-转化模型为数组" class="headerlink" title="8.5.2.1 转化模型为数组"></a>8.5.2.1 转化模型为数组</h4><p>要转化模型及其加载的关联关系为数组，可以使用 <code>toArray</code> 方法。这个方法是递归的，所以所有属性及其关联对象属性（包括关联的关联）都会被转化为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">with</span>(<span class="string">&#x27;roles&#x27;</span>)-&gt;<span class="title function_ invoke__">first</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">toArray</span>();</span><br></pre></td></tr></table></figure>
<p>还可以转化集合为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$users</span>-&gt;<span class="title function_ invoke__">toArray</span>();</span><br></pre></td></tr></table></figure>

<h4 id="8-5-2-2-转化模型为-JSON"><a href="#8-5-2-2-转化模型为-JSON" class="headerlink" title="8.5.2.2 转化模型为 JSON"></a>8.5.2.2 转化模型为 JSON</h4><p>要转化模型为 JSON，可以使用 <code>toJson</code> 方法，和 <code>toArray</code>一样，<code>toJson</code> 方法也是递归的，所有属性及其关联属性都会被转化为 JSON：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">toJson</span>();</span><br></pre></td></tr></table></figure>
<p>你还可以转化模型或集合为字符串，这将会自动调用 <code>toJson</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">string</span>) <span class="variable">$user</span>;</span><br></pre></td></tr></table></figure>
<p>由于模型和集合在转化为字符串的时候会被转化为 JSON，你可以从应用的路由或控制器中直接返回 Eloquent 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;users&#x27;</span>,function()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">App\User</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-5-3-在-JSON-中隐藏属性"><a href="#8-5-3-在-JSON-中隐藏属性" class="headerlink" title="8.5.3 在 JSON 中隐藏属性"></a>8.5.3 在 JSON 中隐藏属性</h3><p>有时候你希望在模型数组或 JSON 显示中隐藏某些属性，比如密码，要实现这个，在定义模型的时候设置 <code>$hidden</code> 属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在数组中隐藏的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hidden</span> = [<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>注意：如果要隐藏关联关系，使用关联关系的方法名，而不是动态属性名。</em></p>
<p>此外，可以使用 <code>visible</code> 属性来定义模型数组和 JSON 显示的属性白名单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在数组中显示的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$visible</span> = [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;last_name&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-5-3-1-临时暴露隐藏属性"><a href="#8-5-3-1-临时暴露隐藏属性" class="headerlink" title="8.5.3.1 临时暴露隐藏属性"></a>8.5.3.1 临时暴露隐藏属性</h4><p>如果你想要在特定模型中临时显示隐藏的属性，可以使用 <code>makeVisible</code> 方法，该方法以方法链的方式返回模型实例：</p>
<pre><code>return $user-&gt;makeVisible(&#39;attribute&#39;)-&gt;toArray();
</code></pre>
<hr>
<h3 id="8-5-4-追加值到-JSON"><a href="#8-5-4-追加值到-JSON" class="headerlink" title="8.5.4 追加值到 JSON"></a>8.5.4 追加值到 JSON</h3><p>有时候，需要添加数据库中没有的字段到数组中，要实现这个功能，首先要为这个值定义一个访问器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为用户获取管理员标识</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIsAdminAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;attributes[<span class="string">&#x27;admin&#x27;</span>] == <span class="string">&#x27;yes&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义好访问器后，添加字段名到该模型的 <code>appends</code> 属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 追加到模型数组表单的访问器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$appends</span> = [<span class="string">&#x27;is_admin&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>字段被添加到 <code>appends</code> 列表之后，将会被包含到模型数组和 JSON 中，<code>appends</code> 数组中的字段还会遵循模型中配置的 <code>visible</code> 和 <code>hidden</code> 设置。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/23e58ff808f7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/23e58ff808f7/" class="post-title-link" itemprop="url">laravel 学习指南 第八章 第四节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 17:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T17:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/23e58ff808f7/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/23e58ff808f7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="8-4-访问器-修改器"><a href="#8-4-访问器-修改器" class="headerlink" title="8.4 访问器&amp;修改器"></a>8.4 访问器&amp;修改器</h2><h3 id="8-4-1-简介"><a href="#8-4-1-简介" class="headerlink" title="8.4.1 简介"></a>8.4.1 简介</h3><p><code>访问器</code>和<code>修改器</code>允许你在获取模型属性或设置其值时格式化 Eloquent 属性。</p>
<p>例如，你可能想要使用Laravel加密器对存储在数据库中的数据进行加密，并且在 Eloquent 模型中访问时自动进行解密。</p>
<p>除了自定义访问器和修改器，Eloquent 还可以自动转换日期字段为Carbon实例，甚至将文本转换为JSON。</p>
<hr>
<h3 id="8-4-2-访问器-修改器"><a href="#8-4-2-访问器-修改器" class="headerlink" title="8.4.2 访问器 &amp; 修改器"></a>8.4.2 访问器 &amp; 修改器</h3><h4 id="8-4-2-1-定义访问器"><a href="#8-4-2-1-定义访问器" class="headerlink" title="8.4.2.1 定义访问器"></a>8.4.2.1 定义访问器</h4><p>要定义一个访问器，需要在模型中创建一个<code>getFooAttribute</code>方法，其中<code>Foo</code>是你想要访问的字段名（使用驼峰式命名规则）。</p>
<p>在本例中，我们将会为<code>first_name</code>属性定义一个访问器，该访问器在获取<code>first_name</code>的值时被 Eloquent 自动调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户的名字</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFirstNameAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">ucfirst</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如你所看到的，该字段的原生值被传递给访问器，然后返回处理过的值。</p>
<p>要访问该值只需要简单访问<code>first_name</code>即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$firstName</span> = <span class="variable">$user</span>-&gt;first_name;</span><br></pre></td></tr></table></figure>

<h4 id="8-4-2-2-定义修改器"><a href="#8-4-2-2-定义修改器" class="headerlink" title="8.4.2.2 定义修改器"></a>8.4.2.2 定义修改器</h4><p>要定义一个修改器，需要在模型中定义<code>setFooAttribute</code>方法，其中<code>Foo</code>是你想要访问的字段（使用驼峰式命名规则）。</p>
<p>接下来让我们为<code>first_name</code>属性定义一个修改器，当我们为模型上的<code>first_name</code>赋值时该修改器会被自动调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置用户的名字</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFirstNameAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;attributes[<span class="string">&#x27;first_name&#x27;</span>] = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该修改器获取要被设置的属性值，允许你操纵该值并设置 Eloquent 模型内部属性值为操作后的值。</p>
<p>例如，如果你尝试设置<code>Sally</code>的<code>first_name</code>属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;first_name = <span class="string">&#x27;Sally&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>在本例中，<code>setFirstNameAttribute</code>方法会被调用，传入参数为<code>Sally</code>，修改器会对其调用<code>strtolower</code>函数并将处理后的值设置为内部属性的值。</p>
<hr>
<h3 id="8-4-3-日期修改器"><a href="#8-4-3-日期修改器" class="headerlink" title="8.4.3 日期修改器"></a>8.4.3 日期修改器</h3><p>默认情况下，Eloquent 将会转化<code>created_at</code>和<code>updated_at</code>列的值为 <code>Carbon</code> 实例，该类继承自 PHP 原生的<code>Datetime</code>类，并提供了各种有用的方法。</p>
<p>你可以自定义哪些字段被自动调整修改，甚至可以通过重写模型中的<code>$dates</code>属性完全禁止调整：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应该被调整为日期的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$dates</span> = [<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;updated_at&#x27;</span>, <span class="string">&#x27;disabled_at&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果字段是日期格式时，你可以将其值设置为 UNIX 时间戳，日期字符串（<code>Y-m-d</code>），日期-时间字符串，<code>Datetime/Carbon</code>实例，日期的值将会自动以正确格式存储到数据库中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;disabled_at = <span class="title class_">Carbon</span>::<span class="title function_ invoke__">now</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
<p>正如上面提到的，当获取被罗列在<code>$dates</code>数组中的属性时，它们会被自动转化为<code>Carbon</code>实例，允许你在属性上使用任何<code>Carbon</code>的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;disabled_at-&gt;<span class="title function_ invoke__">getTimestamp</span>();</span><br></pre></td></tr></table></figure>
<p>默认情况下，时间戳的格式是<code>Y-m-d H:i:s</code>，如果你需要自定义时间戳格式，在模型中设置<code>$dateFormat</code>属性，该属性决定日期属性存储在数据库以及序列化为数组或 <code>JSON</code> 时的格式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模型日期的存储格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$dateFormat</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-4-4-属性转换"><a href="#8-4-4-属性转换" class="headerlink" title="8.4.4 属性转换"></a>8.4.4 属性转换</h3><p>模型中的<code>$casts</code>属性为属性字段转换到通用数据类型提供了便利方法 。<code>$casts</code>属性是数组格式，其键是要被转换的属性名称，其值时你想要转换的类型。目前支持的转换类型包括：<code>integer</code>, <code>real</code>, <code>float</code>, <code>double</code>, <code>string</code>, <code>boolean</code>, <code>object</code>，<code>array</code>，<code>collection</code>，<code>date</code>和<code>datetime</code>。</p>
<p>例如，让我们转换<code>is_admin</code>属性，将其由<code>integer</code>类型（0或1）转换为<code>boolean</code>类型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应该被转化为原生类型的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;is_admin&#x27;</span> =&gt; <span class="string">&#x27;boolean&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，<code>is_admin</code>属性在被访问时总是被转换为<code>boolean</code>，即使底层存储在数据库中的值是<code>integer</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$user</span>-&gt;is_admin) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-4-4-1-数组转换"><a href="#8-4-4-1-数组转换" class="headerlink" title="8.4.4.1 数组转换"></a>8.4.4.1 数组转换</h4><p><code>array</code>类型转换在处理被存储为,序列化 JSON 格式的字段时特别有用。</p>
<p>例如，如果数据库有一个<code>TEXT</code>字段类型包含了序列化<code>JSON</code>，添加<code>array</code>类型转换到该属性将会在 Eloquent 模型中访问其值时自动将其反序列化为<code>PHP</code>数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应该被转化为原生类型的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;options&#x27;</span> =&gt; <span class="string">&#x27;array&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类型转换被定义后，访问<code>options</code>属性将会自动从 <code>JSON</code> 反序列化为 <code>PHP</code> 数组，反之，当你设置<code>options</code>属性的值时，给定数组将会自动转化为 <code>JSON</code> 以供存储：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$options</span> = <span class="variable">$user</span>-&gt;options;</span><br><span class="line"><span class="variable">$options</span>[<span class="string">&#x27;key&#x27;</span>] = <span class="string">&#x27;value&#x27;</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;options = <span class="variable">$options</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/68f82f5c469f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/68f82f5c469f/" class="post-title-link" itemprop="url">laravel 学习指南 第八章 第三节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 16:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T16:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/68f82f5c469f/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/68f82f5c469f/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="8-3-集合"><a href="#8-3-集合" class="headerlink" title="8.3 集合"></a>8.3 集合</h2><h3 id="8-3-1-简介"><a href="#8-3-1-简介" class="headerlink" title="8.3.1 简介"></a>8.3.1 简介</h3><p>Eloquent 返回的所有的,包含多条记录的,结果集,都是 <code>Illuminate\Database\Eloquent\Collection </code>对象的实例，包括通过 <code>get</code> 方法或者,通过访问关联关系获取的结果。Eloquent 集合对象继承自<code>Laravel</code>的集合基类，因此很自然的继承了很多处理 Eloquent 模型底层数组的方法。</p>
<p>当然，所有集合也是迭代器，允许你像数组一样对其进行循环：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$user</span>-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而，集合使用直观接口提供各种映射&#x2F;简化操作，因此比数组更加强大。</p>
<p>例如，我们可以通过以下方式移除所有无效的模型并聚合还存在的用户的名字</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$names</span> = <span class="variable">$users</span>-&gt;<span class="title function_ invoke__">reject</span>(function (<span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$user</span>-&gt;active === <span class="literal">false</span>;</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">map</span>(function (<span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$user</span>-&gt;name;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><em>注意：尽管大多数 Eloquent 集合返回的是一个新的 Eloquent 集合实例，但是<code>pluck</code>、<code>keys</code>、<code>zip</code>、<code>collapse</code>、<code>flatten</code>和<code>flip</code>方法返回的是集合基类实例。</em></p>
<hr>
<h3 id="8-3-2-可用方法"><a href="#8-3-2-可用方法" class="headerlink" title="8.3.2 可用方法"></a>8.3.2 可用方法</h3><p>关于服务的可用方法，可用查看<a target="_blank" rel="noopener" href="http://laravelacademy.org/post/178.html#ipt_kb_toc_178_3">服务-合集</a></p>
<h3 id="8-3-3-自定义集合"><a href="#8-3-3-自定义集合" class="headerlink" title="8.3.3 自定义集合"></a>8.3.3 自定义集合</h3><p>如果你需要在自己扩展的方法中使用自定义的集合对象，可以重写模型上的 <code>newCollection</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">CustomCollection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个新的Eloquent集合实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $models</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Collection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newCollection</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$models</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomCollection</span>(<span class="variable">$models</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义好 <code>newCollection</code> 方法后，无论何时 Eloquent 返回该模型的 <code>Collection</code> 实例你都会获取到自定义的集合。</p>
<p>如果你想要在应用中的每一个模型中使用自定义集合，需要在模型基类中重写 <code>newCollection</code> 方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/331b08b4c413/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/331b08b4c413/" class="post-title-link" itemprop="url">laravel 学习指南 第八章 第二节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 15:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T15:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/331b08b4c413/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/331b08b4c413/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="8-2-关联关系"><a href="#8-2-关联关系" class="headerlink" title="8.2 关联关系"></a>8.2 关联关系</h2><h3 id="8-2-1-简介"><a href="#8-2-1-简介" class="headerlink" title="8.2.1 简介"></a>8.2.1 简介</h3><p>数据表经常要与其它表做关联，比如一篇博客文章可能有很多评论，或者一个订单会被关联到下单用户，Eloquent 使得组织和处理这些关联关系变得简单，并且支持多种不同类型的关联关系：</p>
<ul>
<li>一对一</li>
<li>一对多</li>
<li>多对多</li>
<li>远层一对多</li>
<li>多态关联</li>
<li>多对多的多态关联</li>
</ul>
<hr>
<h3 id="8-2-2-定义关联关系"><a href="#8-2-2-定义关联关系" class="headerlink" title="8.2.2 定义关联关系"></a>8.2.2 定义关联关系</h3><p>Eloquent 关联关系以Eloquent模型类方法的形式被定义。和 Eloquent 模型本身一样，关联关系也是强大的查询构建器，定义关联关系为函数能够提供功能强大的方法链和查询能力。</p>
<p>例如：</p>
<pre><code>$user-&gt;posts()-&gt;where(&#39;active&#39;, 1)-&gt;get();
</code></pre>
<p>但是，在深入使用关联关系之前，让我们先学习如何定义每种关联类型。</p>
<h4 id="8-2-2-1-一对一"><a href="#8-2-2-1-一对一" class="headerlink" title="8.2.2.1 一对一"></a>8.2.2.1 一对一</h4><p>一对一关联是一个非常简单的关联关系，例如，一个<code>User</code>模型有一个与之对应的<code>Phone</code>模型。要定义这种模型，我们需要将<code>phone</code>方法置于<code>User</code>模型中，<code>phone</code>方法应该返回 Eloquent 模型基类,上的<code>hasOne</code><br>方法：</p>
<p>在User模型中，使用<code>hasOne</code>方法，设置<code>photo</code>方法的访问。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取关联到用户的手机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">phone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasOne</span>(<span class="string">&#x27;App\Phone&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传递给<code>hasOne</code>方法的第一个参数是关联模型的名称，关联关系被定义后，我们可以使用 Eloquent 的动态属性获取关联记录。</p>
<p>动态属性允许我们访问关联函数就像它们是定义在模型上的属性一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$phone</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>)-&gt;phone;</span><br></pre></td></tr></table></figure>
<p>Eloquent 默认关联关系的外键基于模型名称，在本例中，<code>Phone</code>模型默认有一个<code>user_id</code>外键，如果你希望重写这种约定，可以传递第二个参数到<code>hasOne</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasOne</span>(<span class="string">&#x27;App\Phone&#x27;</span>, <span class="string">&#x27;foreign_key&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>此外，Eloquent 假设外键应该在父级上有一个与之匹配的<code>id</code>，换句话说，Eloquent 将会通过<code>user</code>表的<code>id</code>值去<code>phone</code>表中查询<code>user_id</code>与之匹配的<code>Phone</code>记录。</p>
<p>如果你想要关联关系使用其他值而不是<code>id</code>，可以传递第三个参数到<code>hasOne</code>来指定自定义的主键：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return $this-&gt;hasOne(&#x27;App\Phone&#x27;, &#x27;foreign_key&#x27;, &#x27;local_key&#x27;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>定义相对的关联</strong></p>
<p>  我们可以从<code>User</code>中访问<code>Phone</code>模型，相应的，我们也可以在<code>Phone</code>模型中定义关联关系从而让我们可以拥有该<code>phone</code>的<code>User</code>。我们可以使用<code>belongsTo</code>方法定义与<code>hasOne</code>关联关系相对的关联：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Phone</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取手机对应的用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\User&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  在上面的例子中，Eloquent 将会尝试通过<code>Phone</code>模型的<code>user_id</code>去<code>User</code>模型查找与之匹配的记录。Eloquent 通过关联关系方法名并在方法名后加<code>_id</code>后缀来生成默认的外键名。然而，如果<code>Phone</code>模型上的外键不是<code>user_id</code>，也可以将自定义的键名作为第二个参数传递到<code>belongsTo</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取手机对应的用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\User&#x27;</span>, <span class="string">&#x27;foreign_key&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  如果父模型不使用id作为主键，或者你希望使用别的列来连接子模型，可以将父表自定义键作为第三个参数传递给belongsTo方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取手机对应的用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\User&#x27;</span>, <span class="string">&#x27;foreign_key&#x27;</span>, <span class="string">&#x27;other_key&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-2-2-2-一对多"><a href="#8-2-2-2-一对多" class="headerlink" title="8.2.2.2 一对多"></a>8.2.2.2 一对多</h4><p>“一对多”是用于定义单个模型拥有多个其它模型的关联关系。</p>
<p>例如，一篇博客文章拥有无数评论，和其他关联关系一样，一对多关联通过在 Eloquent 模型中定义方法来定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取博客文章的评论</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">comments</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMany</span>(<span class="string">&#x27;App\Comment&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记住，Eloquent 会自动判断<code>Comment</code>模型的外键，为方便起见，Eloquent 将拥有者模型名称加上<code>id</code>后缀作为外键。因此，在本例中，Eloquent 假设<code>Comment</code>模型上的外键是<code>post_id</code>。</p>
<p>关联关系被定义后，我们就可以通过访问<code>comments</code>属性来访问评论集合。记住，由于 Eloquent 提供“动态属性”，我们可以像访问模型的属性一样访问关联方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$comments</span> = <span class="title class_">App\Post</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>)-&gt;comments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$comments</span> <span class="keyword">as</span> <span class="variable">$comment</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，由于所有关联同时也是查询构建器，我们可以添加更多的条件约束到通过调用<code>comments</code>方法获取到的评论上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$comments = App\Post::find(1)-&gt;comments()-&gt;where(&#x27;title&#x27;, &#x27;foo&#x27;)-&gt;first();</span><br></pre></td></tr></table></figure>
<p>和<code>hasOne</code>方法一样，你还可以通过传递额外参数到<code>hasMany</code>方法来重新设置外键和本地主键：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return $this-&gt;hasMany(&#x27;App\Comment&#x27;, &#x27;foreign_key&#x27;);</span><br><span class="line">return $this-&gt;hasMany(&#x27;App\Comment&#x27;, &#x27;foreign_key&#x27;, &#x27;local_key&#x27;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>定义相对的关联</strong></p>
<p>  现在我们可以访问文章的所有评论了，接下来让我们定义一个关联关系允许通过评论访问所属文章。要定义与<code>hasMany</code>相对的关联关系，需要在子模型中定义一个关联方法去调用<code>belongsTo</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取评论对应的博客文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Post&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  关联关系定义好之后，我们可以通过访问动态属性<code>post</code>来获取一条<code>Comment</code>对应的<code>Post</code>：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$comment</span> = <span class="title class_">App\Comment</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$comment</span>-&gt;post-&gt;title;</span><br></pre></td></tr></table></figure>
<p>  在上面这个例子中，Eloquent 尝试匹配<code>Comment</code>模型的<code>post_id</code>与<code>Post</code>模型的<code>id</code>，Eloquent 通过关联方法名加上<code>_id</code>后缀生成默认外键，当然，你也可以通过传递自定义外键名作为第二个参数传递到<code>belongsTo</code>方法，如果你的外键不是<code>post_id</code>，或者你想自定义的话：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取评论对应的博客文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Post&#x27;</span>, <span class="string">&#x27;foreign_key&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  如果你的父模型不使用<code>id</code>作为主键，或者你希望通过其他列来连接子模型，可以将自定义键名作为第三个参数传递给<code>belongsTo</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取评论对应的博客文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Post&#x27;</span>, <span class="string">&#x27;foreign_key&#x27;</span>, <span class="string">&#x27;other_key&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-2-2-3-多对多"><a href="#8-2-2-3-多对多" class="headerlink" title="8.2.2.3 多对多"></a>8.2.2.3 多对多</h4><p>多对多关系比<code>hasOne</code>和<code>hasMany</code>关联关系要稍微复杂一些。</p>
<p>这种关联关系的一个例子就是一个用户有多个角色，同时一个角色被多个用户共用。例如，很多用户可能都有一个<code>Admin</code>角色。要定义这样的关联关系，需要三个数据表：<code>users</code>、<code>roles</code>和<code>role_user</code>，<code>role_user</code>表按照关联模型名的字母顺序命名，并且包含<code>user_id</code>和<code>role_id</code>两个列。</p>
<p>多对多关联通过编写一个调用 Eloquent 基类上的<code>belongsToMany</code>方法的函数来定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关联关系被定义之后，可以使用动态属性<code>roles</code>来访问用户的角色：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span>-&gt;roles <span class="keyword">as</span> <span class="variable">$role</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，和所有其它关联关系类型一样，你可以调用<code>roles</code>方法来添加条件约束到关联查询上：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$roles</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>)-&gt;<span class="title function_ invoke__">roles</span>()-&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;name&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>正如前面所提到的，为了决定关联关系连接表的表名，Eloquent以字母顺序连接两个关联模型的名字。然而，你可以重写这种约定——通过传递第二个参数到<code>belongsToMany</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>, <span class="string">&#x27;user_roles&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>除了自定义连接表的表名，你还可以通过传递额外参数到<code>belongsToMany</code>方法来自定义该表中字段的列名。</p>
<p>第三个参数是你定义的关系模型的外键名称，第四个参数你要连接到的模型的外键名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>, <span class="string">&#x27;user_roles&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;role_id&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>定义相对的关联关系</strong></p>
<p>  要定义与多对多关联相对的关联关系，只需在关联模型中在调用一下<code>belongsToMany</code>方法即可。让我们在<code>Role</code>模型中定义<code>users</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 角色用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">users</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\User&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  正如你所看到的，定义的关联关系和与其对应的<code>User</code>中定义的一模一样，只是前者引用<code>App\Role</code>，后者引用<code>App\User</code>，由于我们再次使用了<code>belongsToMany</code>方法，所有的常用表和键自定义选项在定义与多对多相对的关联关系时都是可用的。</p>
</li>
<li><p><strong>获取中间表的列</strong></p>
<p>  正如你已经学习到的，处理多对多关联要求一个中间表。Eloquent 提供了一些有用的方法来与其进行交互。</p>
<p>  例如，我们假设<code>User</code>对象有很多与之关联的<code>Role</code>对象，访问这些关联关系之后，我们可以使用模型上的<code>pivot</code>属性访问中间表：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span>-&gt;roles <span class="keyword">as</span> <span class="variable">$role</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$role</span>-&gt;pivot-&gt;created_at;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  注意我们获取到的每一个<code>Role</code>模型都被自动赋上了<code>pivot</code>属性。该属性包含一个代表中间表的模型，并且可以像其它 Eloquent 模型一样使用。</p>
<p>  默认情况下，只有模型键才能用在pivot对象上，如果你的pivot表包含额外的属性，必须在定义关联关系时进行指定：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>)-&gt;<span class="title function_ invoke__">withPivot</span>(<span class="string">&#x27;column1&#x27;</span>, <span class="string">&#x27;column2&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>  如果你想要你的<code>pivot</code>表自动包含<code>created_at</code>和<code>updated_at</code>时间戳，在关联关系定义时使用<code>withTimestamps</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>)-&gt;<span class="title function_ invoke__">withTimestamps</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>定义中间表过滤</strong></p>
<p>  你还可以对<code>belongsToMany</code>的返回结果使用<code>wherePivot</code>与<code>wherePivotIn</code>过滤：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>)-&gt;<span class="title function_ invoke__">wherePivot</span>(<span class="string">&#x27;approved&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="string">&#x27;App\Role&#x27;</span>)-&gt;<span class="title function_ invoke__">wherePivotIn</span>(<span class="string">&#x27;approved&#x27;</span>, [<span class="number">1</span>, <span class="number">2</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-2-2-4-远层的一对多"><a href="#8-2-2-4-远层的一对多" class="headerlink" title="8.2.2.4 远层的一对多"></a>8.2.2.4 远层的一对多</h4><p>“远层一对多”关联为通过中间关联访问远层的关联关系提供了一个便利之道。</p>
<p>例如：<code>Country</code>模型通过中间的<code>User</code>模型可能拥有多个<code>Post</code>模型。在这个例子中，你可以轻易的找到给定国家的所有文章，让我们看看定义这个关联关系需要哪些表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">countries</span><br><span class="line">    id - integer</span><br><span class="line">    name - string</span><br><span class="line"></span><br><span class="line">users</span><br><span class="line">    id - integer</span><br><span class="line">    country_id - integer</span><br><span class="line">    name - string</span><br><span class="line"></span><br><span class="line">posts</span><br><span class="line">    id - integer</span><br><span class="line">    user_id - integer</span><br><span class="line">    title - string</span><br></pre></td></tr></table></figure>
<p>尽管<code>posts</code>表不包含<code>country_id</code>列，<code>hasManyThrough</code>关联提供了通过<code>$country-&gt;posts</code>来访问一个国家的所有文章。</p>
<p>要执行该查询，Eloquent 在中间表<code>$users</code>上检查<code>country_id</code>，查找到相匹配的用户<code>ID</code>后，通过用户<code>ID</code>来查询<code>posts</code>表。</p>
<p>既然我们已经查看了该关联关系的数据表结构，接下来让我们在<code>Country</code>模型上进行定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定国家的所有文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasManyThrough</span>(<span class="string">&#x27;App\Post&#x27;</span>, <span class="string">&#x27;App\User&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个传递到<code>hasManyThrough</code>方法的参数是最终我们希望访问的模型的名称，第二个参数是中间模型名称。</p>
<p>当执行这种关联查询时通常 Eloquent 外键规则会被使用，如果你想要自定义该关联关系的外键，可以将它们作为第三个、第四个参数传递给<code>hasManyThrough</code>方法。第三个参数是中间模型的外键名，第四个参数是最终模型的外键名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasManyThrough</span>(<span class="string">&#x27;App\Post&#x27;</span>, <span class="string">&#x27;App\User&#x27;</span>, <span class="string">&#x27;country_id&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-2-2-5-多态关联"><a href="#8-2-2-5-多态关联" class="headerlink" title="8.2.2.5 多态关联"></a>8.2.2.5 多态关联</h4><ul>
<li><strong>表结构</strong></li>
</ul>
<p>多态关联允许一个模型在单个关联下属于多个不同模型。</p>
<p>例如，假如应用用户可以对文章点赞也可以对评论点赞，使用多态关联，你可以在这两种场景下使用单个<code>likes</code>表，首先，让我们看看构建这种关联关系需要的表结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">posts</span><br><span class="line">    id - integer</span><br><span class="line">    title - string</span><br><span class="line">    body - text</span><br><span class="line"></span><br><span class="line">comments</span><br><span class="line">    id - integer</span><br><span class="line">    post_id - integer</span><br><span class="line">    body - text</span><br><span class="line"></span><br><span class="line">likes</span><br><span class="line">    id - integer</span><br><span class="line">    likeable_id - integer</span><br><span class="line">    likeable_type - string</span><br></pre></td></tr></table></figure>
<p>两个重要的需要注意的列是 <code>likes</code> 表上的 <code>likeable_id</code> 和 <code>likeable_type</code>。</p>
<p><code>likeable_id</code>列对应 <code>Post</code> 或 <code>Comment</code> 的 <code>ID</code> 值，而 <code>likeable_type</code> 列对应所属模型的类名。当访问 <code>likeable</code> 关联时，ORM 根据 <code>likeable_type</code> 列来判断所属模型的类型并返回相应模型实例。</p>
<ul>
<li><p><strong>模型结构</strong></p>
<p>  接下来，让我们看看构建这种关联关系需要在模型中定义什么：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Like</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所属的likeable模型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">likeable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">morphTo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取该文章的所有点赞</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">likes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">morphMany</span>(<span class="string">&#x27;App\Like&#x27;</span>, <span class="string">&#x27;likeable&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取该评论的所有点赞</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">likes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">morphMany</span>(<span class="string">&#x27;App\Like&#x27;</span>, <span class="string">&#x27;likeable&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>获取多态关联</strong></p>
<p>  数据表和模型定义好以后，可以通过模型访问关联关系。</p>
<p>  例如，要访问一篇文章的所有点赞，可以通过使用动态属性likes ：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="title class_">App\Post</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$post</span>-&gt;likes <span class="keyword">as</span> <span class="variable">$like</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  你还可以通过调用 <code>morphTo</code> 方法从多态模型中获取多态关联的所属对象。在本例中，就是 <code>Like</code> 模型中的 <code>likeable</code> 方法。因此，我们可以用动态属性的方式访问该方法：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$like = App\Like::find(1);</span><br><span class="line">$likeable = $like-&gt;likeable;</span><br></pre></td></tr></table></figure>
<p>  <code>Like</code> 模型的 <code>likeable</code> 关联返回 <code>Post</code> 或 <code>Comment</code> 实例，这取决于哪个类型的模型拥有该点赞。</p>
</li>
</ul>
<h4 id="8-2-2-6-多对多的多态关联"><a href="#8-2-2-6-多对多的多态关联" class="headerlink" title="8.2.2.6 多对多的多态关联"></a>8.2.2.6 多对多的多态关联</h4><ul>
<li><p><strong>表结构</strong></p>
<p>  除了传统的多态关联，还可以定义“多对多”的多态关联，例如，一个博客的 <code>Post</code> 和 <code>Video</code> 模型可能共享一个 <code>Tag</code> 模型的多态关联。</p>
<p>  使用多对多的多态关联允许你在博客文章和视频之间有唯一的标签列表。</p>
<p>  首先，让我们看看表结构：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">posts</span><br><span class="line">    id - integer</span><br><span class="line">    name - string</span><br><span class="line"></span><br><span class="line">videos</span><br><span class="line">    id - integer</span><br><span class="line">    name - string</span><br><span class="line"></span><br><span class="line">tags</span><br><span class="line">    id - integer</span><br><span class="line">    name - string</span><br><span class="line"></span><br><span class="line">taggables</span><br><span class="line">    tag_id - integer</span><br><span class="line">    taggable_id - integer</span><br><span class="line">    taggable_type - string</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>模型结构</strong></p>
<p>  接下来，我们准备在模型中定义该关联关系。<code>Post</code> 和 <code>Video</code> 模型都有一个 <code>tags</code> 方法调用 Eloquent 基类的 <code>morphToMany</code> 方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定文章所有标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">morphToMany</span>(<span class="string">&#x27;App\Tag&#x27;</span>, <span class="string">&#x27;taggable&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>定义相对的关联关系</strong></p>
<p>  接下来，在<code>Tag</code>模型中，应该为每一个关联模型定义一个方法。</p>
<p>  例如，我们定义一个<code>posts</code>方法和<code>videos</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有分配该标签的文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">morphedByMany</span>(<span class="string">&#x27;App\Post&#x27;</span>, <span class="string">&#x27;taggable&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取分配该标签的所有视频</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">videos</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">morphedByMany</span>(<span class="string">&#x27;App\Video&#x27;</span>, <span class="string">&#x27;taggable&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>获取关联关系</strong></p>
<p>  定义好数据库和模型后可以通过模型访问关联关系。</p>
<p>  例如，要访问一篇文章的所有标签，可以使用动态属性tags：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="title class_">App\Post</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$post</span>-&gt;tags <span class="keyword">as</span> <span class="variable">$tag</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  还可以通过访问调用<code>morphedByMany</code>的方法名从多态模型中获取多态关联的所属对象。</p>
<p>  在本例中，就是<code>Tag</code>模型中的<code>posts</code>或者<code>videos</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tag</span> = <span class="title class_">App\Tag</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$tag</span>-&gt;videos <span class="keyword">as</span> <span class="variable">$video</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="8-2-3-关联查询"><a href="#8-2-3-关联查询" class="headerlink" title="8.2.3 关联查询"></a>8.2.3 关联查询</h3><p>由于 Eloquent 所有关联关系都是通过函数定义，你可以调用这些方法来获取关联关系的实例而不需要再去手动执行关联查询。此外，所有 Eloquent 关联关系类型同时也是查询构建器，允许你在最终在数据库执行 SQL 之前继续添加条件约束到关联查询上。</p>
<p>例如，假定在一个博客系统中一个 User 模型有很多相关的 Post 模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定用户的所有文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMany</span>(<span class="string">&#x27;App\Post&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以像这样查询<code>posts</code>关联并添加额外的条件约束到该关联关系上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$user = App\User::find(1);</span><br><span class="line">$user-&gt;posts()-&gt;where(&#x27;active&#x27;, 1)-&gt;get();</span><br></pre></td></tr></table></figure>

<h4 id="8-2-3-1-关联关系方法-VS-动态属性"><a href="#8-2-3-1-关联关系方法-VS-动态属性" class="headerlink" title="8.2.3.1 关联关系方法 VS 动态属性"></a>8.2.3.1 关联关系方法 VS 动态属性</h4><p>如果你不需要添加额外的条件约束到 Eloquent 关联查询，你可以简单通过动态属性来访问关联对象。</p>
<p>例如，还是拿<code>User</code>和<code>Post</code>模型作为例子，你可以像这样访问所有用户的文章：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span>-&gt;posts <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态属性就是“懒惰式加载”，意味着当你真正访问它们的时候才会加载关联数据。</p>
<p>正因为如此，开发者经常使用渴求式加载来预加载他们知道在加载模型时要被访问的关联关系。</p>
<p>渴求式加载有效减少了必须要被执以加载模型关联的 SQL 查询。</p>
<h4 id="8-2-3-2-查询已存在的关联关系"><a href="#8-2-3-2-查询已存在的关联关系" class="headerlink" title="8.2.3.2 查询已存在的关联关系"></a>8.2.3.2 查询已存在的关联关系</h4><p>访问一个模型的记录的时候，你可能希望基于关联关系是否存在来限制查询结果的数目。</p>
<p>例如，假设你想要获取所有至少有一个评论的博客文章，要实现这个，可以传递关联关系的名称到<code>has</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有至少有一条评论的文章...</span></span><br><span class="line"><span class="variable">$posts</span> = <span class="title class_">App\Post</span>::<span class="title function_ invoke__">has</span>(<span class="string">&#x27;comments&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>你还可以指定操作符和大小来自定义查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有至少有三条评论的文章...</span></span><br><span class="line"><span class="variable">$posts</span> = <span class="title class_">Post</span>::<span class="title function_ invoke__">has</span>(<span class="string">&#x27;comments&#x27;</span>, <span class="string">&#x27;&gt;=&#x27;</span>, <span class="number">3</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>还可以使用<code>.</code>来构造嵌套<code>has</code>语句。</p>
<p>例如，你要获取所有至少有一条评论及投票的所有文章：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有至少有一条评论获得投票的文章...</span></span><br><span class="line"><span class="variable">$posts</span> = <span class="title class_">Post</span>::<span class="title function_ invoke__">has</span>(<span class="string">&#x27;comments.votes&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>如果你需要更强大的功能，可以使用<code>whereHas</code>和<code>orWhereHas</code>方法将<code>where</code>条件放到<code>has</code>查询上，这些方法允许你添加自定义条件约束到关联关系条件约束，例如检查一条评论的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有至少有一条评论包含foo字样的文章</span></span><br><span class="line"><span class="variable">$posts</span> = <span class="title class_">Post</span>::<span class="title function_ invoke__">whereHas</span>(<span class="string">&#x27;comments&#x27;</span>, function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;foo%&#x27;</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h4 id="8-2-3-3-渴求式加载"><a href="#8-2-3-3-渴求式加载" class="headerlink" title="8.2.3.3 渴求式加载"></a>8.2.3.3 渴求式加载</h4><p>当以属性方式访问数据库关联关系的时候，关联关系数据是<code>懒惰式加载</code>的，这意味着关联关系数据直到第一次访问的时候才被加载。</p>
<p>然而，Eloquent 可以在查询父级模型的同时，<code>渴求式加载</code>关联关系。渴求式加载缓解了<code>N+1</code>查询问题，要阐明<code>N+1</code>查询问题，考虑下关联到<code>Author</code>的<code>Book</code>模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取写这本书的作者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">author</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Author&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，让我们获取所有书及其作者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$books</span> = <span class="title class_">App\Book</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$books</span> <span class="keyword">as</span> <span class="variable">$book</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$book</span>-&gt;author-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该循环先执行1次查询获取表中的所有书，然后另一个查询获取每一本书的作者，因此，如果有25本书，要执行26次查询：1次是获取书本身，剩下的25次查询是为每一本书获取其作者。</p>
<p>谢天谢地，我们可以使用渴求式加载来减少该操作到2次查询。当查询的时候，可以使用<code>with</code>方法指定应该被渴求式加载的关联关系：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$books</span> = <span class="title class_">App\Book</span>::<span class="title function_ invoke__">with</span>(<span class="string">&#x27;author&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$books</span> <span class="keyword">as</span> <span class="variable">$book</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$book</span>-&gt;author-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在该操作中，只执行两次查询即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from books</span><br><span class="line">select * from authors where id in (1, 2, 3, 4, 5, ...)</span><br></pre></td></tr></table></figure>


<ul>
<li><p><strong>渴求式加载多个关联关系</strong></p>
<p>  有时候你需要在单个操作中渴求式加载几个不同的关联关系。要实现这个，只需要添加额外的参数到<code>with</code>方法即可：</p>
<pre><code>  $books = App\Book::with(&#39;author&#39;, &#39;publisher&#39;)-&gt;get();
</code></pre>
</li>
<li><p><strong>嵌套的渴求式加载</strong></p>
<p>  要渴求式加载嵌套的关联关系，可以使用<code>.</code>语法。例如，让我们在一个Eloquent语句中渴求式加载所有书的作者及所有作者的个人联系方式：</p>
<pre><code>  $books = App\Book::with(&#39;author.contacts&#39;)-&gt;get();
</code></pre>
</li>
</ul>
<h4 id="8-2-3-4-带条件约束的渴求式加载"><a href="#8-2-3-4-带条件约束的渴求式加载" class="headerlink" title="8.2.3.4 带条件约束的渴求式加载"></a>8.2.3.4 带条件约束的渴求式加载</h4><p>有时候我们希望渴求式加载一个关联关系，但还想为渴求式加载指定更多的查询条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">with</span>([<span class="string">&#x27;posts&#x27;</span> =&gt; function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;%first%&#x27;</span>);</span><br><span class="line">&#125;])-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>在这个例子中，Eloquent 只渴求式加载 title 包含 first 的文章。当然，你可以调用其它查询构建器来自定义渴求式加载操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">with</span>([<span class="string">&#x27;posts&#x27;</span> =&gt; function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>);</span><br><span class="line">&#125;])-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h4 id="8-2-3-5-懒惰渴求式加载"><a href="#8-2-3-5-懒惰渴求式加载" class="headerlink" title="8.2.3.5 懒惰渴求式加载"></a>8.2.3.5 懒惰渴求式加载</h4><p>有时候你需要在父模型已经被获取后,渴求式加载一个关联关系。</p>
<p>例如，这在你需要动态决定是否加载关联模型时可能很有用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$books</span> = <span class="title class_">App\Book</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$someCondition</span>) &#123;</span><br><span class="line">    <span class="variable">$books</span>-&gt;<span class="title function_ invoke__">load</span>(<span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;publisher&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你需要设置更多的查询条件到渴求式加载查询上，可以传递一个闭包到<code>load</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$books</span>-&gt;<span class="title function_ invoke__">load</span>([<span class="string">&#x27;author&#x27;</span> =&gt; function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;published_date&#x27;</span>, <span class="string">&#x27;asc&#x27;</span>);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-2-4-插入关联模型"><a href="#8-2-4-插入关联模型" class="headerlink" title="8.2.4 插入关联模型"></a>8.2.4 插入关联模型</h3><h4 id="8-2-4-1-基本使用"><a href="#8-2-4-1-基本使用" class="headerlink" title="8.2.4.1 基本使用"></a>8.2.4.1 基本使用</h4><ul>
<li><p><strong>save方法</strong></p>
<p>  Eloquent 提供了便利的方法来添加新模型到关联关系。</p>
<p>  例如，也许你需要插入新的<code>Comment</code>到<code>Post</code>模型，你可以从关联关系的<code>save</code>方法直接插入<code>Comment</code>而不是手动设置<code>Comment</code>的<code>post_id</code>属性：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$comment</span> = <span class="keyword">new</span> <span class="title class_">App\Comment</span>([<span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;A new comment.&#x27;</span>]);</span><br><span class="line"><span class="variable">$post</span> = <span class="title class_">App\Post</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$post</span>-&gt;<span class="title function_ invoke__">comments</span>()-&gt;<span class="title function_ invoke__">save</span>(<span class="variable">$comment</span>);</span><br></pre></td></tr></table></figure>
<p>  注意我们没有用动态属性方式访问<code>comments</code>，而是调用<code>comments</code>方法获取关联关系实例。<code>save</code>方法会自动添加<code>post_id</code>值到新的<code>Comment</code>模型。</p>
<p>  如果你需要保存多个关联模型，可以使用<code>saveMany</code>方法：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$post = App\Post::find(1);</span><br><span class="line"></span><br><span class="line">$post-&gt;comments()-&gt;saveMany([</span><br><span class="line">    new App\Comment([&#x27;message&#x27; =&gt; &#x27;A new comment.&#x27;]),</span><br><span class="line">    new App\Comment([&#x27;message&#x27; =&gt; &#x27;Another comment.&#x27;]),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>save &amp; 多对多关联</strong></p>
<p>  当处理多对多关联的时候，<code>save</code>方法以数组形式接收额外的中间表属性作为第二个参数：</p>
<pre><code>  App\User::find(1)-&gt;roles()-&gt;save($role, [&#39;expires&#39; =&gt; $expires]);
</code></pre>
</li>
<li><p><strong>create方法</strong></p>
<p>  除了<code>save</code>和<code>saveMany</code>方法外，还可以使用<code>create</code>方法，该方法接收属性数组、创建模型、然后插入数据库。<code>save</code>和<code>create</code>的不同之处在于<code>save</code>接收整个Eloquent模型实例而<code>create</code>接收原生PHP数组：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="title class_">App\Post</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$comment</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">comments</span>()-&gt;<span class="title function_ invoke__">create</span>([</span><br><span class="line">    <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;A new comment.&#x27;</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>  使用<code>create</code>方法之前确保先浏览属性[批量赋值]文档(<a target="_blank" rel="noopener" href="http://laravelacademy.org/post/2995.html)%E3%80%82">http://laravelacademy.org/post/2995.html)。</a></p>
</li>
</ul>
<h4 id="8-2-4-2-更新”属于“关联"><a href="#8-2-4-2-更新”属于“关联" class="headerlink" title="8.2.4.2 更新”属于“关联"></a>8.2.4.2 更新”属于“关联</h4><p>更新<code>belongsTo</code>关联的时候，可以使用<code>associate</code>方法，该方法会在子模型设置外键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$account</span> = <span class="title class_">App\Account</span>::<span class="title function_ invoke__">find</span>(<span class="number">10</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">account</span>()-&gt;<span class="title function_ invoke__">associate</span>(<span class="variable">$account</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
<p>移除<code>belongsTo</code>关联的时候，可以使用<code>dissociate</code>方法。该方法在子模型上取消外键和关联：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">account</span>()-&gt;<span class="title function_ invoke__">dissociate</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>

<h4 id="8-2-4-3-多对多关联"><a href="#8-2-4-3-多对多关联" class="headerlink" title="8.2.4.3 多对多关联"></a>8.2.4.3 多对多关联</h4><ul>
<li><p><strong>附加&#x2F;分离</strong></p>
<p>  处理多对多关联的时候，Eloquent提供了一些额外的帮助函数来使得处理关联模型变得更加方便。</p>
<p>  例如，让我们假定一个用户可能有多个角色同时一个角色属于多个用户，要通过在连接模型的中间表中插入记录附加角色到用户上，可以使用<code>attach</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">roles</span>()-&gt;<span class="title function_ invoke__">attach</span>(<span class="variable">$roleId</span>);</span><br></pre></td></tr></table></figure>
<p>  附加关联关系到模型，还可以以数组形式传递额外被插入数据到中间表：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;roles()-&gt;attach($roleId, [&#x27;expires&#x27; =&gt; $expires]);</span><br></pre></td></tr></table></figure>
<p>  当然，有时候有必要从用户中移除角色，要移除一个多对多关联记录，使用<code>detach</code>方法。<code>detach</code>方法将会从中间表中移除相应的记录；然而，两个模型在数据库中都保持不变：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 从指定用户中移除角色...</span><br><span class="line">$user-&gt;roles()-&gt;detach($roleId);</span><br><span class="line">// 从指定用户移除所有角色...</span><br><span class="line">$user-&gt;roles()-&gt;detach();</span><br></pre></td></tr></table></figure>
<p>  为了方便，<code>attach</code>和<code>detach</code>还接收数组形式的 ID 作为输入：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$user = App\User::find(1);</span><br><span class="line">$user-&gt;roles()-&gt;detach([1, 2, 3]);</span><br><span class="line">$user-&gt;roles()-&gt;attach([1 =&gt; [&#x27;expires&#x27; =&gt; $expires], 2, 3]);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>同步</strong></p>
<p>  你还可以使用<code>sync</code>方法构建多对多关联。<code>sync</code>方法接收数组形式的<code>ID</code>并将其放置到中间表。任何不在该数组中的<code>ID</code>对应记录将会从中间表中移除。因此，该操作完成后，只有在数组中的<code>ID</code>对应记录还存在于中间表：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;roles()-&gt;sync([1, 2, 3]);</span><br></pre></td></tr></table></figure>
<p>  你还可以和ID一起传递额外的中间表值:</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;roles()-&gt;sync([1 =&gt; [&#x27;expires&#x27; =&gt; true], 2, 3]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-2-4-4-触发父级时间戳"><a href="#8-2-4-4-触发父级时间戳" class="headerlink" title="8.2.4.4 触发父级时间戳"></a>8.2.4.4 触发父级时间戳</h4><p>当一个模型属于另外一个时，例如<code>Comment</code>属于<code>Post</code>，子模型更新时父模型的时间戳也被更新将很有用。</p>
<p>例如，当<code>Comment</code>模型被更新时，你可能想要<code>触发</code>创建其所属模型<code>Post</code>的<code>updated_at</code>时间戳。</p>
<p>Eloquent使得这项操作变得简单，只需要添加包含关联关系名称的<code>touches</code>属性到子模型中即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 要触发的所有关联关系</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$touches</span> = [<span class="string">&#x27;post&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论所属文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Post&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，当你更新<code>Comment</code>时，所属模型<code>Post</code>将也会更新其<code>updated_at</code>值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$comment</span> = <span class="title class_">App\Comment</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$comment</span>-&gt;text = <span class="string">&#x27;Edit to this comment!&#x27;</span>;</span><br><span class="line"><span class="variable">$comment</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/c9cbd0eea6cb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/c9cbd0eea6cb/" class="post-title-link" itemprop="url">laravel 学习指南 第八章 第一节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 14:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T14:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/c9cbd0eea6cb/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/c9cbd0eea6cb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="8-Eloquent-ORM"><a href="#8-Eloquent-ORM" class="headerlink" title="8. Eloquent ORM"></a>8. Eloquent ORM</h2><h2 id="8-1-起步"><a href="#8-1-起步" class="headerlink" title="8.1 起步"></a>8.1 起步</h2><h3 id="8-1-1-简介"><a href="#8-1-1-简介" class="headerlink" title="8.1.1 简介"></a>8.1.1 简介</h3><p>Laravel 自带的 <code>Eloquent ORM </code>提供了一个美观、简单的与数据库打交道的 <code>ActiveRecord</code> 实现方法，每张数据表都对应一个与该表进行交互的“模型”，模型允许你在表中进行数据查询，以及插入、更新、删除等操作。</p>
<p>在开始之前，确保在config&#x2F;database.php文件中配置好了数据库连接。更多关于数据库配置的信息，请查看文档。</p>
<hr>
<h3 id="8-1-2-定义模型"><a href="#8-1-2-定义模型" class="headerlink" title="8.1.2 定义模型"></a>8.1.2 定义模型</h3><p>作为开始，让我们创建一个 <code>Eloquent</code> 模型，模型通常位于<code>app目录</code>下，你也可以将其放在其他可以被<code>composer.json</code>文件自动加载的地方。所有Eloquent模型都继承自 <code>Illuminate\Database\Eloquent\Model</code>类。</p>
<p>创建模型实例最简单的办法就是使用 Artisan 命令<code>make:model</code>：</p>
<pre><code>php artisan make:model User
</code></pre>
<p>如果你想要在生成模型时生成数据库迁移，可以使用<code>--migration</code>或<code>-m</code>选项：</p>
<pre><code>php artisan make:model User --migration
php artisan make:model User -m
</code></pre>
<h4 id="8-1-2-1-Eloquent-模型约定"><a href="#8-1-2-1-Eloquent-模型约定" class="headerlink" title="8.1.2.1 Eloquent 模型约定"></a>8.1.2.1 Eloquent 模型约定</h4><p>现在，让我们来看一个 <code>Flight </code>模型类例子，我们将用该类获取和存取数据表<code>flights</code>中的信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>表名</strong></p>
<p>  注意我们并没有告诉 <code>Eloquent</code> 我们的<code>Flight</code>模型使用哪张表。默认规则是模型类名的复数作为与其对应的表名，除非在模型类中明确指定了其它名称。</p>
<p>  所以，在本例中，Eloquent 认为<code>Flight</code>模型存储记录在<code>flights</code>表中。你也可以在模型中定义table属性来指定自定义的表名：</p>
<p>  下面例子中表明被定义为<code>my_flights</code></p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关联到模型的数据表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">&#x27;my_flights&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>主键</strong></p>
<p>  Eloquent 默认每张表的主键名为<code>id</code>，你可以在模型类中定义一个<code>$primaryKey</code>属性来覆盖该设置。</p>
</li>
<li><p><strong>时间戳</strong></p>
<p>  默认情况下，Eloquent 期望<code>created_at</code>和<code>updated_at</code>已经存在于数据表中，如果你不想要这些 Laravel 自动管理的列，在模型类中设置<code>$timestamps</code>属性为<code>false</code>：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表明模型是否应该被打上时间戳</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$timestamps</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  如果你需要自定义时间戳格式，设置模型中的<code>$dateFormat</code>属性。该属性决定日期被如何存储到数据库中，以及模型被序列化为数组或 JSON 时日期的格式：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模型日期列的存储格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$dateFormat</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>数据库连接</strong></p>
<p>  默认情况下，所有的 Eloquent 模型使用应用配置中的默认数据库连接，如果你想要为模型指定不同的连接，可以通过 <code>$connection</code>属性来设置。</p>
<p>  这里的<code>Flight</code>模型，默认连接到<code>Flights</code>。设置后将<code>Flight</code>模型连接到<code>connection_name</code>，这里的<code>connection_name</code>可以随意命名。</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The connection name for the model.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$connection</span> = <span class="string">&#x27;connection_name&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="8-1-3-获取多个模型"><a href="#8-1-3-获取多个模型" class="headerlink" title="8.1.3 获取多个模型"></a>8.1.3 获取多个模型</h3><p>创建完模型及其关联的数据表后，就要准备从数据库中获取数据。将Eloquent模型看作功能强大的查询构建器，你可以使用它来流畅的查询与其关联的数据表。</p>
<p>例如：例子中将<code>Flights</code>表中全部数据，注入到<code>flight.index</code>页面中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Flight</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlightController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显示所有有效航班列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$flights</span> = <span class="title class_">Flight</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">view</span>(<span class="string">&#x27;flight.index&#x27;</span>, [<span class="string">&#x27;flights&#x27;</span> =&gt; <span class="variable">$flights</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-1-3-1-访问列值"><a href="#8-1-3-1-访问列值" class="headerlink" title="8.1.3.1 访问列值"></a>8.1.3.1 访问列值</h4><p>如果你有一个 Eloquent 模型实例，可以通过访问其相应的属性来访问模型的列值。</p>
<p>例如，让我们循环查询返回的每一个<code>Flight</code>实例并输出<code>name</code>的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$flights</span> <span class="keyword">as</span> <span class="variable">$flight</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flight</span>-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-1-3-2-添加额外约束"><a href="#8-1-3-2-添加额外约束" class="headerlink" title="8.1.3.2 添加额外约束"></a>8.1.3.2 添加额外约束</h4><p>Eloquent 的<code>all</code>方法返回模型表的所有结果，由于每一个Eloquent模型都是一个查询构建器，你还可以添加约束条件到查询，然后使用get方法获取对应结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flights</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">               -&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line">               -&gt;<span class="title function_ invoke__">take</span>(<span class="number">10</span>)</span><br><span class="line">               -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p><em>注意：由于 Eloquent 模型本质上就是查询构建器，你可以在Eloquent查询中使用查询构建器的所有方法</em></p>
<h4 id="8-1-3-3-集合"><a href="#8-1-3-3-集合" class="headerlink" title="8.1.3.3 集合"></a>8.1.3.3 集合</h4><p>对 Eloquent 中获取多个结果的方法（比如<code>all</code>和<code>get</code>）而言，其返回值是<code>Illuminate\Database\Eloquent\Collection</code>的一个实例，<code>Collection</code>类提供了多个有用的函数来处理Eloquent结果。</p>
<p>当然，你可以像操作数组一样简单循环这个集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$flights</span> <span class="keyword">as</span> <span class="variable">$flight</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flight</span>-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-1-3-4-组块结果集"><a href="#8-1-3-4-组块结果集" class="headerlink" title="8.1.3.4 组块结果集"></a>8.1.3.4 组块结果集</h4><p>如果你需要处理成千上万个 Eloquent 结果，可以使用<code>chunk</code>命令。<code>chunk</code>方法会获取一个“组块”的 Eloquent 模型，并将其填充到给定闭包进行处理。使用<code>chunk</code>方法能够在处理大量数据集合时有效减少内存消耗：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Flight</span>::<span class="title function_ invoke__">chunk</span>(<span class="number">200</span>, function (<span class="variable">$flights</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$flights</span> <span class="keyword">as</span> <span class="variable">$flight</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>传递给该方法的第一个参数是你想要获取的<code>组块</code>数目，闭包作为第二个参数被调用用于处理每个从数据库获取的区块数据。</p>
<hr>
<h3 id="8-1-4-获取单个模型-聚合"><a href="#8-1-4-获取单个模型-聚合" class="headerlink" title="8.1.4 获取单个模型&#x2F;聚合"></a>8.1.4 获取单个模型&#x2F;聚合</h3><p>当然，除了从给定表中获取所有记录之外，还可以使用<code>find</code>和<code>first</code>获取单个记录。这些方法返回单个模型实例而不是返回模型集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过主键获取模型...</span></span><br><span class="line"><span class="variable">$flight</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 获取匹配查询条件的第一个模型...</span></span><br><span class="line"><span class="variable">$flight</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">first</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Not Found 异常</strong></li>
</ul>
<p>有时候你可能想要在模型找不到的时候抛出异常，这在路由或控制器中非常有用，<code>findOrFail</code>和<code>firstOrFail</code>方法会获取查询到的第一个结果。</p>
<p>然而，如果没有任何查询结果，<code>Illuminate\Database\Eloquent\ModelNotFoundException</code>异常将会被抛出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$model</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$model</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;legs&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">100</span>)-&gt;<span class="title function_ invoke__">firstOrFail</span>();</span><br></pre></td></tr></table></figure>
<p>如果异常没有被捕获，那么HTTP 404 响应将会被发送给用户，所以在使用这些方法的时候没有必要对返回404响应编写明确的检查：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/api/flights/&#123;id&#125;&#x27;</span>, function (<span class="variable">$id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="variable">$id</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="8-1-4-1-获取聚合"><a href="#8-1-4-1-获取聚合" class="headerlink" title="8.1.4.1 获取聚合"></a>8.1.4.1 获取聚合</h4><p>当然，你还可以使用查询构建器聚合方法，例如<code>count</code>、<code>sum</code>、<code>max</code>，以及其它查询构建器提供的聚合方法。这些方法返回计算后的结果而不是整个模型实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$count</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">count</span>();</span><br><span class="line"><span class="variable">$max</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">max</span>(<span class="string">&#x27;price&#x27;</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-1-5-插入-更新模型"><a href="#8-1-5-插入-更新模型" class="headerlink" title="8.1.5 插入&#x2F;更新模型"></a>8.1.5 插入&#x2F;更新模型</h3><h4 id="8-1-5-1-基本插入"><a href="#8-1-5-1-基本插入" class="headerlink" title="8.1.5.1 基本插入"></a>8.1.5.1 基本插入</h4><p>想要在数据库中插入新的记录，只需创建一个新的模型实例，设置模型的属性，然后调用<code>save</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Flight</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlightController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个新的航班实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Validate the request...</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$flight</span> = <span class="keyword">new</span> <span class="title class_">Flight</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$flight</span>-&gt;name = <span class="variable">$request</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子中，我们只是简单分配HTTP请求中的<code>name</code>参数值给<code>App\Flight</code>模型实例的那么属性，当我们调用<code>save</code>方法时，一条记录将会被插入数据库。<code>created_at</code>和<code>updated_at</code>时间戳在<code>save</code>方法被调用时会自动被设置，所以没必要手动设置它们。</p>
<h4 id="8-1-5-2-基本更新"><a href="#8-1-5-2-基本更新" class="headerlink" title="8.1.5.2 基本更新"></a>8.1.5.2 基本更新</h4><p><code>save</code>方法还可以用于更新数据库中已存在的模型。要更新一个模型，应该先获取它，设置你想要更新的属性，然后调用<code>save</code>方法。同样，<code>updated_at</code>时间戳会被自动更新，所以没必要手动设置其值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flight</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$flight</span>-&gt;name = <span class="string">&#x27;New Flight Name&#x27;</span>;</span><br><span class="line"><span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
<p>更新操作还可以同时修改给定查询提供的多个模型实例，在本例中，所有有效且<code>destination=San Diego</code>的航班都被标记为延迟：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">App\Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">          -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;destination&#x27;</span>, <span class="string">&#x27;San Diego&#x27;</span>)</span><br><span class="line">          -&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;delayed&#x27;</span> =&gt; <span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p><code>update</code>方法要求以数组形式传递键值对参数，代表着数据表中应该被更新的列。</p>
<h4 id="8-1-5-3-批量赋值"><a href="#8-1-5-3-批量赋值" class="headerlink" title="8.1.5.3 批量赋值"></a>8.1.5.3 批量赋值</h4><p>还可以使用<code>create</code>方法保存一个新的模型。该方法返回被插入的模型实例。</p>
<p>但是，在此之前，你需要指定模型的<code>fillable</code>或<code>guarded</code>属性，因为所有Eloquent模型都通过批量赋值（Mass Assignment）进行保护。</p>
<p>当用户通过 HTTP 请求传递一个不被期望的参数值时就会出现安全隐患，然后该参数以不被期望的方式修改数据库中的列值。</p>
<p>例如，恶意用户通过 HTTP 请求发送一个<code>is_admin</code>参数，然后该参数映射到模型的create方法，从而允许用户将自己变成管理员。</p>
<p>所以，你应该在模型中定义哪些属性是可以进行赋值的，使用模型上的<code>$fillable</code>属性即可实现。</p>
<p>例如，我们设置<code>Flight</code>模型上的<code>name</code>属性可以被赋值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可以被批量赋值的属性.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$fillable</span> = [<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置完可以被赋值的属性之后，我们就可以使用<code>create</code>方法在数据库中插入一条新的记录。<code>create</code>方法返回保存后的模型实例：</p>
<pre><code>$flight = App\Flight::create([&#39;name&#39; =&gt; &#39;Flight 10&#39;]);
</code></pre>
<p><code>$fillable</code>就像是可以被赋值属性的“白名单”，还可以选择使用<code>$guarded</code>。<code>$guarded</code>属性包含你不想被赋值的属性数组。所以不被包含在其中的属性都是可以被赋值的，因此，<code>$guarded</code>方法就像“黑名单”。</p>
<p>当然，你只能同时使用其中一个——而不是一起使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不能被批量赋值的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$guarded</span> = [<span class="string">&#x27;price&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子中，除了<code>$price</code>之外的所有属性都是可以被赋值的。</p>
<ul>
<li><p><strong>其它创建方法</strong></p>
<p>  还有其它两种可以用来创建模型的方法：<code>firstOrCreate</code>和<code>firstOrNew</code>。</p>
<p>  <code>firstOrCreate</code>方法先尝试通过给定列&#x2F;值对在数据库中查找记录，如果没有找到的话则通过给定属性创建一个新的记录。</p>
<p>  <code>firstOrNew</code>方法和<code>firstOrCreate</code>方法一样先尝试在数据库中查找匹配的记录，如果没有找到，则返回一个的模型实例。</p>
<p>  注意通过<code>firstOrNew</code>方法返回的模型实例并没有持久化到数据库中，你还需要调用<code>save</code>方法手动持久化：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过属性获取航班, 如果不存在则创建...</span></span><br><span class="line"><span class="variable">$flight</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">firstOrCreate</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;Flight 10&#x27;</span>]);</span><br><span class="line"><span class="comment">// 通过属性获取航班, 如果不存在初始化一个新的实例...</span></span><br><span class="line"><span class="variable">$flight</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">firstOrNew</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;Flight 10&#x27;</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="8-1-6-删除模型"><a href="#8-1-6-删除模型" class="headerlink" title="8.1.6 删除模型"></a>8.1.6 删除模型</h3><p>要删除一个模型，调用模型实例上的<code>delete</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$flight = App\Flight::find(1);</span><br><span class="line">$flight-&gt;delete();</span><br></pre></td></tr></table></figure>

<h4 id="8-1-6-1-通过主键删除模型"><a href="#8-1-6-1-通过主键删除模型" class="headerlink" title="8.1.6.1 通过主键删除模型"></a>8.1.6.1 通过主键删除模型</h4><p>在上面的例子中，我们在调用<code>delete</code>方法之前从数据库中获取该模型，然而，如果你知道模型的主键的话，可以调用<code>destroy</code>方法直接删除而不需要获取它：</p>
<p>下方三种方式相同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">App\Flight::destroy(1);</span><br><span class="line">App\Flight::destroy([1, 2, 3]);</span><br><span class="line">App\Flight::destroy(1, 2, 3);</span><br></pre></td></tr></table></figure>

<h4 id="8-1-6-2-通过查询删除模型"><a href="#8-1-6-2-通过查询删除模型" class="headerlink" title="8.1.6.2 通过查询删除模型"></a>8.1.6.2 通过查询删除模型</h4><p>当然，你还可以通过查询删除多个模型，在本例中，我们删除所有被标记为无效的航班：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$deletedRows = App\Flight::where(&#x27;active&#x27;, 0)-&gt;delete();</span><br></pre></td></tr></table></figure>

<h4 id="8-1-6-3-软删除"><a href="#8-1-6-3-软删除" class="headerlink" title="8.1.6.3 软删除"></a>8.1.6.3 软删除</h4><p>除了从数据库删除记录外，Eloquent还可以对模型进行“软删除”。当模型被软删除后，它们并没有真的从数据库删除，而是在模型上设置一个<code>deleted_at</code>属性并插入数据库，如果模型有一个非空<code>deleted_at</code>值，那么该模型已经被软删除了。</p>
<p>要启用模型的软删除功能，可以使用模型上的<code>Illuminate\Database\Eloquent\SoftDeletes</code>方法并添加<code>deleted_at</code>列到<code>$dates</code>属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">SoftDeletes</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SoftDeletes</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应该被调整为日期的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$dates</span> = [<span class="string">&#x27;deleted_at&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，应该添加<code>deleted_at</code>列到数据表。Laravel Schema构建器包含一个帮助函数来创建该列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Schema</span>::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;flights&#x27;</span>, function (<span class="variable">$table</span>) &#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">softDeletes</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>现在，当调用模型的<code>delete</code>方法时，<code>deleted_at</code>列将被设置为当前日期和时间，并且，当查询一个使用软删除的模型时，被软删除的模型将会自动从查询结果中排除。</p>
<p>判断给定模型实例是否被软删除，可以使用<code>trashed</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">trashed</span>()) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-1-6-4-查询被软删除的模型"><a href="#8-1-6-4-查询被软删除的模型" class="headerlink" title="8.1.6.4 查询被软删除的模型"></a>8.1.6.4 查询被软删除的模型</h4><ul>
<li><p><strong>包含软删除模型</strong></p>
<p>  正如上面提到的，软删除模型将会自动从查询结果中排除，但是，如果你想要软删除模型出现在查询结果中，可以使用<code>withTrashed</code>方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flights</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">withTrashed</span>()</span><br><span class="line">                -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;account_id&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>  <code>withTrashed</code>方法也可以用于关联查询中：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">history</span>()-&gt;<span class="title function_ invoke__">withTrashed</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>只获取软删除模型</strong></p>
<p>  <code>onlyTrashed</code>方法之获取软删除模型：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flights</span> = <span class="title class_">App\Flight</span>::<span class="title function_ invoke__">onlyTrashed</span>()</span><br><span class="line">                -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;airline_id&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>恢复软删除模型</strong></p>
<p>  有时候你希望恢复一个被软删除的模型，可以使用<code>restore</code>方法：</p>
<pre><code>  $flight-&gt;restore();
</code></pre>
<p>  你还可以在查询中使用<code>restore</code>方法来快速恢复多个模型：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">App\Flight</span>::<span class="title function_ invoke__">withTrashed</span>()</span><br><span class="line">        -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;airline_id&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">restore</span>();</span><br></pre></td></tr></table></figure>
<p>  和<code>withTrashed</code>方法一样，<code>restore</code>方法也可以用于关联查询：</p>
<pre><code>  $flight-&gt;history()-&gt;restore();
</code></pre>
</li>
<li><p><strong>永久删除模型</strong></p>
<p>  有时候你真的需要从数据库中删除一个模型，可以使用forceDelete方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 强制删除单个模型实例...</span></span><br><span class="line"><span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">forceDelete</span>();</span><br><span class="line"><span class="comment">// 强制删除所有关联模型...</span></span><br><span class="line"><span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">history</span>()-&gt;<span class="title function_ invoke__">forceDelete</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="8-1-7-查询作用域"><a href="#8-1-7-查询作用域" class="headerlink" title="8.1.7 查询作用域"></a>8.1.7 查询作用域</h3><h4 id="8-1-7-1-全局作用域"><a href="#8-1-7-1-全局作用域" class="headerlink" title="8.1.7.1 全局作用域"></a>8.1.7.1 全局作用域</h4><p>全局作用域允许我们为给定模型的所有查询添加条件约束。Laravel 自带的软删除功能就使用了全局作用域来从数据库中拉出所有没有被删除的模型。编写自定义的全局作用域可以提供一种方便的、简单的方式来确保给定模型的每个查询都有特定的条件约束。</p>
<ul>
<li><p><strong>编写全局作用域</strong></p>
<p>  自定义全局作用域很简单，首先定义一个实现 <code>Illuminate\Database\Eloquent\Scope</code> 接口的类，该接口要求你实现一个方法：<code>apply</code>。需要的话可以在 <code>apply</code> 方法中添加 <code>where</code> 条件到查询：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Scopes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Scope</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AgeScope</span> <span class="keyword">implements</span> <span class="title">Scope</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Apply the scope to a given Eloquent query builder.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Database\Eloquent\Builder  $builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Database\Eloquent\Model  $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span>(<span class="params">Builder <span class="variable">$builder</span>, Model <span class="variable">$model</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$builder</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>应用全局作用域</strong></p>
<p>  要将全局作用域分配给模型，需要重写给定模型的 <code>boot</code> 方法并使用 <code>addGlobalScope</code> 方法：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Scopes</span>\<span class="title">AgeScope</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The &quot;booting&quot; method of the model.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">boot</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">static</span>::<span class="title function_ invoke__">addGlobalScope</span>(<span class="keyword">new</span> <span class="title class_">AgeScope</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  添加作用域后，如果使用 <code>User::all()</code> 查询则会生成如下SQL语句：</p>
<pre><code>  select * from `users` where `age` &gt; 200
</code></pre>
</li>
<li><p><strong>匿名的全局作用域</strong></p>
</li>
</ul>
<p>Eloquent还允许我们使用闭包定义全局作用域，这在实现简单作用域的时候特别有用，这样的话，我们就没必要定义一个单独的类了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The &quot;booting&quot; method of the model.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">boot</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">static</span>::<span class="title function_ invoke__">addGlobalScope</span>(<span class="string">&#x27;age&#x27;</span>, function(Builder <span class="variable">$builder</span>) &#123;</span><br><span class="line">            <span class="variable">$builder</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们还可以通过以下方式移除全局作用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withoutGlobalScope</span>(<span class="string">&#x27;age&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>移除全局作用域</strong></li>
</ul>
<p>如果想要在给定查询中移除指定全局作用域，可以使用 <code>withoutGlobalScope</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withoutGlobalScope</span>(<span class="title class_">AgeScope</span>::<span class="variable language_">class</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>如果你想要移除某几个或全部全局作用域，可以使用 <code>withoutGlobalScopes</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withoutGlobalScopes</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withoutGlobalScopes</span>([<span class="title class_">FirstScope</span>::<span class="variable language_">class</span>, <span class="title class_">SecondScope</span>::<span class="variable language_">class</span>])-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>


<h4 id="8-1-7-2-本地作用域"><a href="#8-1-7-2-本地作用域" class="headerlink" title="8.1.7.2 本地作用域"></a>8.1.7.2 本地作用域</h4><p>本地作用域允许我们定义通用的约束集合以便在应用中复用。</p>
<p>例如，你可能经常需要获取最受欢迎的用户，要定义这样的一个作用域，只需简单在对应Eloquent模型方法前加上一个<code>scope</code>前缀，作用域总是返回查询构建器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只包含活跃用户的查询作用域</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopePopular</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只包含激活用户的查询作用域</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeActive</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>使用查询作用域</strong></p>
<p>  作用域被定义好了之后，就可以在查询模型的时候调用作用域方法，但调用时不需要加上<code>scope</code>前缀，你甚至可以在同时调用多个作用域，例如：</p>
<pre><code>  $users = App\User::popular()-&gt;active()-&gt;orderBy(&#39;created_at&#39;)-&gt;get();
</code></pre>
</li>
<li><p><strong>动态作用域</strong></p>
<p>  有时候你可能想要定义一个可以接收参数的作用域，你只需要将额外的参数添加到你的作用域即可。作用域参数应该被定义在<code>$query</code>参数之后：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只包含给用类型用户的查询作用域</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeOfType</span>(<span class="params"><span class="variable">$query</span>, <span class="variable">$type</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;type&#x27;</span>, <span class="variable">$type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  现在，你可以在调用作用域时传递参数了：</p>
<pre><code>  $users = App\User::ofType(&#39;admin&#39;)-&gt;get();
</code></pre>
</li>
</ul>
<hr>
<h3 id="8-1-8-事件"><a href="#8-1-8-事件" class="headerlink" title="8.1.8 事件"></a>8.1.8 事件</h3><p>Eloquent模型可以触发事件，允许你在模型生命周期中的多个时间点调用如下这些方法：<code>creating</code>, <code>created</code>, <code>updating</code>, <code>updated</code>, <code>saving</code>, <code>saved</code>,<code>deleting</code>, <code>deleted</code>, <code>restoring</code>, <code>restored</code>。事件允许你在一个指定模型类每次保存或更新的时候执行代码。</p>
<h4 id="8-1-8-1-基本使用"><a href="#8-1-8-1-基本使用" class="headerlink" title="8.1.8.1 基本使用"></a>8.1.8.1 基本使用</h4><p>一个新模型被首次保存的时候，<code>creating</code>和<code>created</code>事件会被触发。</p>
<p>如果一个模型已经在数据库中存在并调用<code>save</code>方法，<code>updating / updated</code>事件会被触发，无论是创建还是更新，<code>saving / saved</code>事件都会被调用。</p>
<p>举个例子，我们在服务提供者中定义一个<code>Eloquent事件监听器</code>，在事件监听器中，我们会调用给定模型的<code>isValid</code>方法，如果模型无效会返回<code>false</code>。如果从<code>Eloquent事件监听器</code>中返回<code>false</code>则取消<code>save/update</code>操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动所有应用服务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title class_">User</span>::<span class="title function_ invoke__">creating</span>(function (<span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( ! <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">isValid</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册服务提供者.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/f984dd9711e2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/f984dd9711e2/" class="post-title-link" itemprop="url">laravel 学习指南 第七章 第四节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 13:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T13:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/f984dd9711e2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/f984dd9711e2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="7-4-填充数据"><a href="#7-4-填充数据" class="headerlink" title="7.4 填充数据"></a>7.4 填充数据</h2><h3 id="7-4-1-简介"><a href="#7-4-1-简介" class="headerlink" title="7.4.1 简介"></a>7.4.1 简介</h3><p>Laravel 包含了一个简单方法来填充数据库——使用填充类和测试数据。</p>
<p>所有的填充类都位于<code>database/seeds</code>目录。</p>
<p>填充类的类名完全由你自定义，但最好还是遵循一定的规则，比如可读性,例如<code>UserTableSeeder</code>等等。</p>
<p>安装完 Laravel 后，会默认提供一个<code>DatabaseSeeder</code>类。</p>
<p>从这个类中，你可以使用<code>call</code>方法来运行其他填充类，从而允许你控制填充顺序。</p>
<hr>
<h3 id="7-4-2-编写填充器"><a href="#7-4-2-编写填充器" class="headerlink" title="7.4.2 编写填充器"></a>7.4.2 编写填充器</h3><p>要生成一个填充器，可以通过 Artisan 命令<code>make:seeder</code>。所有框架生成的填充器都位于<code>database/seeders</code>目录：</p>
<pre><code>php artisan make:seeder UserTableSeeder
</code></pre>
<p>一个填充器类默认只包含一个方法：<code>run</code>。当Artisan命令<code>db:seed</code>运行时该方法被调用。在<code>run</code>方法中，可以插入任何你想插入数据库的数据，你可以使用查询构建器手动插入数据，也可以使用 Eloquent 模型工厂。</p>
<p>举个例子，让我们修改 Laravel 安装时自带的<code>DatabaseSeeder</code>类，添加一个数据库插入语句到<code>run</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Seeder;</span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line"></span><br><span class="line">class DatabaseSeeder extends Seeder&#123;</span><br><span class="line">    /**</span><br><span class="line">     * 运行数据库填充</span><br><span class="line">     *</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function run()</span><br><span class="line">    &#123;</span><br><span class="line">        DB::table(&#x27;users&#x27;)-&gt;insert([</span><br><span class="line">            &#x27;name&#x27; =&gt; str_random(10),</span><br><span class="line">            &#x27;email&#x27; =&gt; str_random(10).&#x27;@gmail.com&#x27;,</span><br><span class="line">            &#x27;password&#x27; =&gt; bcrypt(&#x27;secret&#x27;),</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-4-2-1-使用模型工厂"><a href="#7-4-2-1-使用模型工厂" class="headerlink" title="7.4.2.1 使用模型工厂"></a>7.4.2.1 使用模型工厂</h4><p>当然，手动指定每一个模型填充的属性是很笨重累赘的，取而代之的，我们可以使用模型工厂来方便的生成大量的数据库记录。首先，查看模型工厂文档来学习如何定义工厂，定义工厂后，可以使用帮助函数<code>factory</code>来插入记录到数据库。</p>
<p>举个例子，让我们创建50个用户并添加关联关系到每个用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 运行数据库填充</span><br><span class="line"> *</span><br><span class="line"> * @return void</span><br><span class="line"> */</span><br><span class="line">public function run()&#123;</span><br><span class="line">    factory(&#x27;App\User&#x27;, 50)-&gt;create()-&gt;each(function($u) &#123;</span><br><span class="line">        $u-&gt;posts()-&gt;save(factory(&#x27;App\Post&#x27;)-&gt;make());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-4-2-2-调用额外的填充器"><a href="#7-4-2-2-调用额外的填充器" class="headerlink" title="7.4.2.2 调用额外的填充器"></a>7.4.2.2 调用额外的填充器</h4><p>在<code>DatabaseSeeder</code>类中，你可以使用<code>call</code>方法执行额外的填充类，使用<code>call</code>方法允许你将数据库填充分解成多个文件，这样单个填充器类就不会变得无比巨大，只需简单将你想要运行的填充器类名传递过去即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 运行数据库填充</span><br><span class="line">*</span><br><span class="line">* @return void</span><br><span class="line">*/</span><br><span class="line">public function run()&#123;</span><br><span class="line">    Model::unguard();</span><br><span class="line"></span><br><span class="line">    $this-&gt;call(UserTableSeeder::class);</span><br><span class="line">    $this-&gt;call(PostsTableSeeder::class);</span><br><span class="line">    $this-&gt;call(CommentsTableSeeder::class);</span><br><span class="line"></span><br><span class="line">    Model::reguard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="7-4-3-运行填充器"><a href="#7-4-3-运行填充器" class="headerlink" title="7.4.3 运行填充器"></a>7.4.3 运行填充器</h3><p>编写好填充器类之后，可以使用 Artisan 命令<code>db:seed</code>来填充数据库。默认情况下，<code>db:seed</code>命令运行可以用来运行其它填充器类的<code>DatabaseSeeder</code>类，但是，你也可以使用<code>--class </code>选项来指定你想要运行的独立的填充器类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php artisan db:seed</span><br><span class="line">php artisan db:seed --class=UserTableSeeder</span><br></pre></td></tr></table></figure>
<p>你还可以使用<code>migrate:refresh</code>命令来填充数据库，该命令还可以回滚并重新运行迁移，这在需要完全重建数据库时很有用：</p>
<pre><code>php artisan migrate:refresh --seed
</code></pre>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/7e5f24379817/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/7e5f24379817/" class="post-title-link" itemprop="url">laravel 学习指南 第七章 第三节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 12:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T12:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/7e5f24379817/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/7e5f24379817/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="7-3-迁移"><a href="#7-3-迁移" class="headerlink" title="7.3 迁移"></a>7.3 迁移</h2><h3 id="7-3-1-简介"><a href="#7-3-1-简介" class="headerlink" title="7.3.1 简介"></a>7.3.1 简介</h3><p>迁移就像数据库的版本控制，允许团队简单轻松的编辑并共享应用的数据库表结构，迁移通常搭配 Laravel 结构构建器，可以很容易地构建应用的数据库表结构。</p>
<p>Laravel的<code>Schema门面</code>提供了与数据库系统无关的创建和操纵表的支持，在 Laravel 所支持的所有数据库系统中提供一致的、优雅的、平滑的API。</p>
<hr>
<h3 id="7-3-2-生成迁移"><a href="#7-3-2-生成迁移" class="headerlink" title="7.3.2 生成迁移"></a>7.3.2 生成迁移</h3><p>使用 <code>Artisan</code> 命令<code>make:migration</code>来创建一个新的迁移：</p>
<pre><code>php artisan make:migration create_users_table
</code></pre>
<p>新的迁移位于<code>database/migrations</code>目录下，每个迁移文件名都包含时间戳从而允许 Laravel 判断其顺序。</p>
<p><code>--table</code>和<code>--create</code>选项可以用于指定表名以及该迁移是否要创建一个新的数据表。这些选项只需要简单放在上述迁移命令后面并指定表名：</p>
<pre><code>php artisan make:migration add_votes_to_users_table --table=users
php artisan make:migration create_users_table --create=users
</code></pre>
<p>如果你想要指定生成迁移的自定义输出路径，在执行<code>make:migration</code>命令时可以使用<code>--path</code>选项，提供的路径应该是相对于应用根目录的。</p>
<hr>
<h3 id="7-3-3-迁移结构"><a href="#7-3-3-迁移结构" class="headerlink" title="7.3.3 迁移结构"></a>7.3.3 迁移结构</h3><p>迁移类包含了两个方法：<code>up</code>和<code>down</code>。</p>
<p><code>up</code>方法用于新增表，列或者索引到数据库，而<code>down</code>方法就是<code>up</code>方法的反操作，和<code>up</code>里的操作相反。</p>
<p>在这两个方法中你都要用到 Laravel 的表结构构建器来创建和修改表.</p>
<p>例如:让我们先看看创建<code>flights</code>表的简单示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateFlightsTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 运行迁移</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title class_">Schema</span>::<span class="title function_ invoke__">create</span>(<span class="string">&#x27;flights&#x27;</span>, function (Blueprint <span class="variable">$table</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">increments</span>(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;<span class="keyword">string</span>(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;<span class="keyword">string</span>(<span class="string">&#x27;airline&#x27;</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">timestamps</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 撤销迁移</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title class_">Schema</span>::<span class="title function_ invoke__">drop</span>(<span class="string">&#x27;flights&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-3-4-运行迁移"><a href="#7-3-4-运行迁移" class="headerlink" title="7.3.4 运行迁移"></a>7.3.4 运行迁移</h3><p>要运行应用中所有未执行的迁移，可以使用 Artisan 命令的<code>migrate</code>方法。</p>
<p>如果你正在使用Homestead虚拟机，应该在你的虚拟机中运行如下这条命令：</p>
<pre><code>php artisan migrate
</code></pre>
<p>如果再运行时遇到“class not found”的错误提示，尝试运行<code>composer dump-autoload</code>命令然后重新运行迁移命令。</p>
<ul>
<li><p><strong>在生产环境中强制运行迁移</strong></p>
<p>  有些迁移操作是毁灭性的，这意味着它们可能造成数据的丢失，为了避免在生产环境数据库中运行这些命令，你将会在运行这些命令之前被提示并确认。想要强制运行这些命令而不被提示，可以使用<code>--force</code>：</p>
<pre><code>  php artisan migrate --force
</code></pre>
</li>
</ul>
<h4 id="7-3-4-1-回滚迁移"><a href="#7-3-4-1-回滚迁移" class="headerlink" title="7.3.4.1 回滚迁移"></a>7.3.4.1 回滚迁移</h4><p>想要回滚最新的一次迁移<code>操作</code>，可以使用<code>rollback</code>命令，注意这将会回滚最后一批运行的迁移，可能包含多个迁移文件：</p>
<pre><code>php artisan migrate:rollback
</code></pre>
<p><code>migrate:reset</code>命令将会回滚所有的应用迁移：</p>
<pre><code>php artisan migrate:reset
</code></pre>
<ul>
<li><p><strong>在单个命令中回滚&#x2F;迁移</strong></p>
<p>  <code>migrate:refresh</code>命令将会先回滚所有数据库迁移，然后运行<code>migrate</code>命令。这个命令可以有效的重建整个数据库：</p>
<pre><code>  php artisan migrate:refresh
  php artisan migrate:refresh --seed
</code></pre>
</li>
</ul>
<hr>
<h3 id="7-3-5-编写迁移"><a href="#7-3-5-编写迁移" class="headerlink" title="7.3.5 编写迁移"></a>7.3.5 编写迁移</h3><h4 id="7-3-5-1-创建表"><a href="#7-3-5-1-创建表" class="headerlink" title="7.3.5.1 创建表"></a>7.3.5.1 创建表</h4><p>使用<code>Schema门面</code>上的<code>create</code>方法来创建新的数据表。<code>create</code>方法接收两个参数，第一个是表名，第二个是获取用于定义新表的<code>Blueprint</code>对象的闭包：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Schema</span>::<span class="title function_ invoke__">create</span>(<span class="string">&#x27;users&#x27;</span>, function (<span class="variable">$table</span>) &#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">increments</span>(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当然，创建新表的时候，可以使用表结构构建器中的任意列方法来定义数据表的列。</p>
<ul>
<li><p><strong>检查表&#x2F;列是否存在</strong></p>
<p>  你可以轻松地使用 <code>hasTable</code> 和 <code>hasColumn</code> 方法检查表或列是否存在：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Schema</span>::<span class="title function_ invoke__">hasTable</span>(<span class="string">&#x27;users&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Schema</span>::<span class="title function_ invoke__">hasColumn</span>(<span class="string">&#x27;users&#x27;</span>, <span class="string">&#x27;email&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p><strong>连接&amp;存储引擎</strong></p>
<p>  如果你想要在一个数据库连接上执行表结构操作，该数据库连接并不是默认数据库连接，使用<code>connection</code>方法：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::connection(&#x27;foo&#x27;)-&gt;create(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;increments(&#x27;id&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>  要设置表的存储引擎，在表结构构建器上设置<code>engine</code>属性：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;engine = &#x27;InnoDB&#x27;;</span><br><span class="line">    $table-&gt;increments(&#x27;id&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-3-5-2-重命名-删除表"><a href="#7-3-5-2-重命名-删除表" class="headerlink" title="7.3.5.2 重命名&#x2F;删除表"></a>7.3.5.2 重命名&#x2F;删除表</h4><p>要重命名一个已存在的数据表，使用<code>rename</code>方法：</p>
<pre><code>Schema::rename($from, $to);
</code></pre>
<p>要删除一个已存在的数据表，可以使用<code>drop</code>或<code>dropIfExists</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Schema::drop(&#x27;users&#x27;);</span><br><span class="line">Schema::dropIfExists(&#x27;users&#x27;);</span><br></pre></td></tr></table></figure>

<h4 id="7-3-5-3-创建列"><a href="#7-3-5-3-创建列" class="headerlink" title="7.3.5.3 创建列"></a>7.3.5.3 创建列</h4><p>要更新一个已存在的表，使用<code>Schema门面</code>上的<code>table</code>方法，和<code>create</code>方法一样，<code>table</code>方法接收两个参数：表名和获取用于添加列到表的<code>Blueprint</code>实例的闭包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;string(&#x27;email&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>可用的列类型</strong></li>
</ul>
<p>当然，表结构构建器包含一系列你可以用来构建表的列类型：</p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$table-&gt;bigIncrements(‘id’);</td>
<td align="left">自增ID，类型为bigint</td>
</tr>
<tr>
<td align="left">$table-&gt;bigInteger(‘votes’);</td>
<td align="left">等同于数据库中的BIGINT类型</td>
</tr>
<tr>
<td align="left">$table-&gt;binary(‘data’);</td>
<td align="left">等同于数据库中的BLOB类型</td>
</tr>
<tr>
<td align="left">$table-&gt;boolean(‘confirmed’);</td>
<td align="left">等同于数据库中的BOOLEAN类型</td>
</tr>
<tr>
<td align="left">$table-&gt;char(‘name’, 4);</td>
<td align="left">等同于数据库中的CHAR类型</td>
</tr>
<tr>
<td align="left">$table-&gt;date(‘created_at’);</td>
<td align="left">等同于数据库中的DATE类型</td>
</tr>
<tr>
<td align="left">$table-&gt;dateTime(‘created_at’);</td>
<td align="left">等同于数据库中的DATETIME类型</td>
</tr>
<tr>
<td align="left">$table-&gt;decimal(‘amount’, 5, 2);</td>
<td align="left">等同于数据库中的DECIMAL类型，带一个精度和范围</td>
</tr>
<tr>
<td align="left">$table-&gt;double(‘column’, 15, 8);</td>
<td align="left">等同于数据库中的DOUBLE类型，带精度, 总共15位数字，小数点后8位.</td>
</tr>
<tr>
<td align="left">$table-&gt;enum(‘choices’, [‘foo’, ‘bar’]);</td>
<td align="left">等同于数据库中的 ENUM类型</td>
</tr>
<tr>
<td align="left">$table-&gt;float(‘amount’);</td>
<td align="left">等同于数据库中的 FLOAT 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;increments(‘id’);</td>
<td align="left">数据库主键自增ID</td>
</tr>
<tr>
<td align="left">$table-&gt;integer(‘votes’);</td>
<td align="left">等同于数据库中的 INTEGER 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;json(‘options’);</td>
<td align="left">等同于数据库中的 JSON 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;jsonb(‘options’);</td>
<td align="left">等同于数据库中的 JSONB 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;longText(‘description’);</td>
<td align="left">等同于数据库中的 LONGTEXT 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;mediumInteger(‘numbers’);</td>
<td align="left">等同于数据库中的 MEDIUMINT类型</td>
</tr>
<tr>
<td align="left">$table-&gt;mediumText(‘description’);</td>
<td align="left">等同于数据库中的 MEDIUMTEXT类型</td>
</tr>
<tr>
<td align="left">$table-&gt;morphs(‘taggable’);</td>
<td align="left">添加一个 INTEGER类型的 <code>taggable_id</code> 列和一个 STRING类型的 <code>taggable_type</code>列</td>
</tr>
<tr>
<td align="left">$table-&gt;nullableTimestamps();</td>
<td align="left">和 <code>timestamps()</code>一样但允许 NULL值.</td>
</tr>
<tr>
<td align="left">$table-&gt;rememberToken();</td>
<td align="left">添加一个 <code>remember_token</code> 列： VARCHAR(100) NULL.</td>
</tr>
<tr>
<td align="left">$table-&gt;smallInteger(‘votes’);</td>
<td align="left">等同于数据库中的 SMALLINT 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;softDeletes();</td>
<td align="left">新增一个 deleted_at 列 用于软删除.</td>
</tr>
<tr>
<td align="left">$table-&gt;string(‘email’);</td>
<td align="left">等同于数据库中的 VARCHAR 列  .</td>
</tr>
<tr>
<td align="left">$table-&gt;string(‘name’, 100);</td>
<td align="left">等同于数据库中的 VARCHAR，带一个长度</td>
</tr>
<tr>
<td align="left">$table-&gt;text(‘description’);</td>
<td align="left">等同于数据库中的 TEXT 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;time(‘sunrise’);</td>
<td align="left">等同于数据库中的 TIME类型</td>
</tr>
<tr>
<td align="left">$table-&gt;tinyInteger(‘numbers’);</td>
<td align="left">等同于数据库中的 TINYINT 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;timestamp(‘added_on’);</td>
<td align="left">等同于数据库中的 TIMESTAMP 类型</td>
</tr>
<tr>
<td align="left">$table-&gt;timestamps();</td>
<td align="left">添加 <code>created_at</code> 和 <code>updated_at</code>列.</td>
</tr>
<tr>
<td align="left">$table-&gt;uuid(‘id’);</td>
<td align="left">等同于数据库的UUID</td>
</tr>
</tbody></table>
<h4 id="7-3-5-4-列修改器"><a href="#7-3-5-4-列修改器" class="headerlink" title="7.3.5.4 列修改器"></a>7.3.5.4 列修改器</h4><p>除了上面列出的列类型之外，在添加列的时候还可以使用一些其它列“修改器”。</p>
<p>例如:要使列默认为<code>null</code>，可以使用<code>nullable</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;string(&#x27;email&#x27;)-&gt;nullable();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面是所有可用的列修改器列表，该列表不包含索引修改器：</p>
<table>
<thead>
<tr>
<th align="left">修改器</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-&gt;first()</td>
<td align="left">将该列置为表中第一个列 (仅适用于MySQL)</td>
</tr>
<tr>
<td align="left">-&gt;after(‘column’)</td>
<td align="left">将该列置于另一个列之后 (仅适用于MySQL)</td>
</tr>
<tr>
<td align="left">-&gt;nullable()</td>
<td align="left">允许该列的值为NULL</td>
</tr>
<tr>
<td align="left">-&gt;default($value)</td>
<td align="left">指定列的默认值</td>
</tr>
<tr>
<td align="left">-&gt;unsigned()</td>
<td align="left">设置 <code>integer</code> 列为 <code>UNSIGNED</code></td>
</tr>
</tbody></table>
<h4 id="7-3-5-5-修改列"><a href="#7-3-5-5-修改列" class="headerlink" title="7.3.5.5 修改列"></a>7.3.5.5 修改列</h4><ul>
<li><p><strong>先决条件</strong></p>
<p>  在修改列之前，确保已经将<code>doctrine/dbal</code>依赖添加到<code>composer.json</code>文件，Doctrine DBAL 库用于判断列的当前状态并在需要时创建SQL查询来对列进行指定的调整。</p>
</li>
<li><p><strong>更新列属性</strong></p>
<p>  <code>change</code>方法允许你修改已存在的列为新的类型，或者修改列的属性。例如，你可能想要增加 string 类型列的尺寸，让我们将<code>name</code>列的尺寸从 25 增加到 50：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;string(&#x27;name&#x27;, 50)-&gt;change();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>  我们还可以修改该列允许 NULL 值：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;string(&#x27;name&#x27;, 50)-&gt;nullable()-&gt;change();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>重命名列</strong></p>
</li>
</ul>
<p>要重命名一个列，可以使用表结构构建器上的<code>renameColumn</code>方法，在重命名一个列之前，确保<code>doctrine/dbal</code>依赖已经添加到<code>composer.json</code>文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;renameColumn(&#x27;from&#x27;, &#x27;to&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><em>注意：暂不支持 enum类型的列的重命名。</em></p>
<h4 id="7-3-5-6-删除列"><a href="#7-3-5-6-删除列" class="headerlink" title="7.3.5.6 删除列"></a>7.3.5.6 删除列</h4><p>要删除一个列，使用表结构构建器上的<code>dropColumn</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;dropColumn(&#x27;votes&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>你可以传递列名数组到<code>dropColumn</code>方法从表中删除多个列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;users&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;dropColumn([&#x27;votes&#x27;, &#x27;avatar&#x27;, &#x27;location&#x27;]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><em>注意：在从SQLite数据库删除列之前，需要添加<code>doctrine/dbal</code>依赖到<code>composer.json</code>文件并在终端中运行<code>composer update命</code>令来安装该库。此外，SQLite数据库暂不支持在单个迁移中删除或修改多个列。</em></p>
<h4 id="7-3-5-7-创建索引"><a href="#7-3-5-7-创建索引" class="headerlink" title="7.3.5.7 创建索引"></a>7.3.5.7 创建索引</h4><p>表结构构建器支持多种类型的索引，首先，让我们看一个指定列值为唯一索引的例子。要创建索引，可以使用<code>unique</code>方法：</p>
<pre><code>$table-&gt;string(&#39;email&#39;)-&gt;unique();
</code></pre>
<p>此外，你可以在定义列之后创建索引，例如：</p>
<pre><code>$table-&gt;unique(&#39;email&#39;);
</code></pre>
<p>你甚至可以传递列名数组到索引方法来创建组合索引：</p>
<pre><code>$table-&gt;index([&#39;account_id&#39;, &#39;created_at&#39;]);
</code></pre>
<p>Laravel 会自动生成合理的索引名称，但是你可以传递第二个参数到该方法用于指定索引名称：</p>
<pre><code>$table-&gt;index(&#39;email&#39;, &#39;my_index_name&#39;);
</code></pre>
<ul>
<li><p><strong>可用索引类型</strong></p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$table-&gt;primary(‘id’);</td>
<td align="left">添加主键索引</td>
</tr>
<tr>
<td align="left">$table-&gt;primary([‘first’, ‘last’]);</td>
<td align="left">添加混合索引</td>
</tr>
<tr>
<td align="left">$table-&gt;unique(‘email’);</td>
<td align="left">添加唯一索引</td>
</tr>
<tr>
<td align="left">$table-&gt;unique(‘state’, ‘my_index_name’);</td>
<td align="left">指定自定义索引名称</td>
</tr>
<tr>
<td align="left">$table-&gt;index(‘state’);</td>
<td align="left">添加普通索引</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="7-3-5-8-删除索引"><a href="#7-3-5-8-删除索引" class="headerlink" title="7.3.5.8 删除索引"></a>7.3.5.8 删除索引</h4><p>要删除索引，必须指定索引名。默认情况下，Laravel 自动分配适当的名称给索引——简单连接表名、列名和索引类型。下面是一些例子：</p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$table-&gt;dropPrimary(‘users_id_primary’);</td>
<td align="left">从 “users”表中删除主键索引</td>
</tr>
<tr>
<td align="left">$table-&gt;dropUnique(‘users_email_unique’);</td>
<td align="left">从 “users”表中删除唯一索引</td>
</tr>
<tr>
<td align="left">$table-&gt;dropIndex(‘geo_state_index’);</td>
<td align="left">从 “geo”表中删除普通索引</td>
</tr>
</tbody></table>
<h4 id="7-3-5-9-外键约束"><a href="#7-3-5-9-外键约束" class="headerlink" title="7.3.5.9 外键约束"></a>7.3.5.9 外键约束</h4><p>Laravel 还提供了创建外键约束的支持，用于在数据库层面强制引用完整性。例如，我们在<code>posts</code>表中定义了一个引用<code>users</code>表的<code>id</code>列的<code>user_id</code>列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Schema::table(&#x27;posts&#x27;, function ($table) &#123;</span><br><span class="line">    $table-&gt;integer(&#x27;user_id&#x27;)-&gt;unsigned();</span><br><span class="line">    $table-&gt;foreign(&#x27;user_id&#x27;)-&gt;references(&#x27;id&#x27;)-&gt;on(&#x27;users&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>你还可以为约束的<code>on delete</code>和<code>on update</code>属性指定期望的动作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$table-&gt;foreign(&#x27;user_id&#x27;)</span><br><span class="line">      -&gt;references(&#x27;id&#x27;)-&gt;on(&#x27;users&#x27;)</span><br><span class="line">      -&gt;onDelete(&#x27;cascade&#x27;);</span><br></pre></td></tr></table></figure>

<p>要删除一个外键，可以使用<code>dropForeign</code>方法。外键约束和索引使用同样的命名规则——连接表名、外键名然后加上<code>_foreign</code>后缀：</p>
<pre><code>$table-&gt;dropForeign(&#39;posts_user_id_foreign&#39;);
</code></pre>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/f1816657eb28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/f1816657eb28/" class="post-title-link" itemprop="url">laravel 学习指南 第七章 第二节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 11:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T11:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/f1816657eb28/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/f1816657eb28/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="7-2-查询构建器"><a href="#7-2-查询构建器" class="headerlink" title="7.2 查询构建器"></a>7.2 查询构建器</h2><h3 id="7-2-1-简介"><a href="#7-2-1-简介" class="headerlink" title="7.2.1 简介"></a>7.2.1 简介</h3><p><code>数据库查询构建器</code>提供了一个方便的、平滑的接口来创建和运行<code>数据库查询</code>。<code>查询构建器</code>可以用于执行应用中大部分数据库操作，并且能够在支持的所有数据库系统上工作。</p>
<p><em>注意：Laravel 查询构建器使用<code> PDO 参数</code>绑定来避免 SQL 注入攻击，不再需要过滤传递到绑定的字符串。</em></p>
<hr>
<h3 id="7-2-2-获取结果集"><a href="#7-2-2-获取结果集" class="headerlink" title="7.2.2 获取结果集"></a>7.2.2 获取结果集</h3><h4 id="7-2-2-1-从一张表中取出所有行"><a href="#7-2-2-1-从一张表中取出所有行" class="headerlink" title="7.2.2.1 从一张表中取出所有行"></a>7.2.2.1 从一张表中取出所有行</h4><p>在查询之前，使用<code>DB门面</code>的<code>table</code>方法，<code>table</code>方法为给定表返回一个查询构建器，允许你在查询上链接更多约束条件并最终返回查询结果。在本例中，我们使用<code>get</code>方法获取表中所有记录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显示用户列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">view</span>(<span class="string">&#x27;user.index&#x27;</span>, [<span class="string">&#x27;users&#x27;</span> =&gt; <span class="variable">$users</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和原生查询一样，get方法返回结果集的数组，其中每一个结果都是PHP对象的StdClass实例。你可以像访问对象的属性一样访问列的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$user</span>-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-2-从一张表中获取一行-一列"><a href="#7-2-2-2-从一张表中获取一行-一列" class="headerlink" title="7.2.2.2 从一张表中获取一行&#x2F;一列"></a>7.2.2.2 从一张表中获取一行&#x2F;一列</h4><p>如果你只是想要从数据表中获取一行数据，可以使用<code>first</code>方法，该方法将会返回单个<code>StdClass</code>对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;John&#x27;</span>)-&gt;<span class="title function_ invoke__">first</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$user</span>-&gt;name;</span><br></pre></td></tr></table></figure>
<p>如果你不需要完整的一行，可以使用value方法从结果中获取单个值，该方法会直接返回指定列的值：</p>
<pre><code>$email = DB::table(&#39;users&#39;)-&gt;where(&#39;name&#39;, &#39;John&#39;)-&gt;value(&#39;email&#39;);
</code></pre>
<h4 id="7-2-2-3-从一张表中获取组块结果集"><a href="#7-2-2-3-从一张表中获取组块结果集" class="headerlink" title="7.2.2.3 从一张表中获取组块结果集"></a>7.2.2.3 从一张表中获取组块结果集</h4><p>如果你需要处理成千上百条数据库记录，可以考虑使用<code>chunk</code>方法，该方法一次获取结果集的一小块，然后填充每一小块数据到要处理的闭包，该方法在编写处理大量数据库记录的 <code>Artisan 命令</code>的时候非常有用。</p>
<p>例如：我们可以将处理全部 <code>users</code> 表数据，处理成一次处理 100 条记录的小组块：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">chunk</span>(<span class="number">100</span>, function(<span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>你可以通过从闭包函数中返回false来中止组块的运行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">chunk</span>(<span class="number">100</span>, function(<span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理结果集...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-4-获取数据列值列表"><a href="#7-2-2-4-获取数据列值列表" class="headerlink" title="7.2.2.4 获取数据列值列表"></a>7.2.2.4 获取数据列值列表</h4><h4 id="7-2-2-5-聚合函数"><a href="#7-2-2-5-聚合函数" class="headerlink" title="7.2.2.5 聚合函数"></a>7.2.2.5 聚合函数</h4><p>队列构建器还提供了很多聚合方法，比如<code>count</code>, <code>max</code>, <code>min</code>, <code>avg</code>, 和 <code>sum</code>，你可以在构造查询之后调用这些方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">count</span>();</span><br><span class="line"><span class="variable">$price</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;orders&#x27;</span>)-&gt;<span class="title function_ invoke__">max</span>(<span class="string">&#x27;price&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>当然，你可以联合其它查询子句和聚合函数来构建查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$price</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;orders&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;finalized&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">avg</span>(<span class="string">&#x27;price&#x27;</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-2-3-查询（Select）"><a href="#7-2-3-查询（Select）" class="headerlink" title="7.2.3 查询（Select）"></a>7.2.3 查询（Select）</h3><h4 id="7-2-3-1-指定查询子句"><a href="#7-2-3-1-指定查询子句" class="headerlink" title="7.2.3.1 指定查询子句"></a>7.2.3.1 指定查询子句</h4><p>当然，我们并不总是想要获取数据表的所有列，使用<code>select</code>方法，你可以为查询指定自定义的<code>select</code>子句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email as user_email&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p><code>distinct</code>方法允许你强制查询返回不重复的结果集：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">distinct</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>如果你已经有了一个查询构建器实例并且希望添加一个查询列到已存在的<code>select</code>子句，可以使用<code>addSelect</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line"><span class="variable">$users</span> = <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">addSelect</span>(<span class="string">&#x27;age&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<h4 id="7-2-3-2-原生表达式"><a href="#7-2-3-2-原生表达式" class="headerlink" title="7.2.3.2 原生表达式"></a>7.2.3.2 原生表达式</h4><p>有时候你希望在查询中使用原生表达式，这些表达式将会以字符串的形式注入到查询中，所以要格外小心避免被 SQL 注入。想要创建一个原生表达式，可以使用<code>DB::raw</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                     -&gt;<span class="title function_ invoke__">select</span>(DB::<span class="title function_ invoke__">raw</span>(<span class="string">&#x27;count(*) as user_count, status&#x27;</span>))</span><br><span class="line">                     -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;&lt;&gt;&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                     -&gt;<span class="title function_ invoke__">groupBy</span>(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">                     -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-2-4-连接（Join）"><a href="#7-2-4-连接（Join）" class="headerlink" title="7.2.4 连接（Join）"></a>7.2.4 连接（Join）</h3><h4 id="7-2-4-1-内连接（等值连接）"><a href="#7-2-4-1-内连接（等值连接）" class="headerlink" title="7.2.4.1 内连接（等值连接）"></a>7.2.4.1 内连接（等值连接）</h4><p>查询构建器还可以用于编写基本的SQL“内连接”，你可以使用查询构建器实例上的<code>join</code>方法，传递给<code>join</code>方法的第一次参数是你需要连接到的表名，剩余的其它参数则是为连接指定的列约束，当然，正如你所看到的，你可以在单个查询中连接多张表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">join</span>(<span class="string">&#x27;contacts&#x27;</span>, <span class="string">&#x27;users.id&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;contacts.user_id&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">join</span>(<span class="string">&#x27;orders&#x27;</span>, <span class="string">&#x27;users.id&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;orders.user_id&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;users.*&#x27;</span>, <span class="string">&#x27;contacts.phone&#x27;</span>, <span class="string">&#x27;orders.price&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h4 id="7-2-4-2-左连接"><a href="#7-2-4-2-左连接" class="headerlink" title="7.2.4.2 左连接"></a>7.2.4.2 左连接</h4><p>如果你是想要执行“左连接”而不是“内连接”，可以使用<code>leftJoin</code>方法。该方法和<code>join</code>方法的使用方法一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">leftJoin</span>(<span class="string">&#x27;posts&#x27;</span>, <span class="string">&#x27;users.id&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;posts.user_id&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h4 id="7-2-4-3-高级连接语句"><a href="#7-2-4-3-高级连接语句" class="headerlink" title="7.2.4.3 高级连接语句"></a>7.2.4.3 高级连接语句</h4><p>你还可以指定更多的高级连接子句，传递一个闭包到<code>join</code>方法作为该方法的第2个参数，该闭包将会返回允许你指定<code>join</code>子句约束的<code>JoinClause</code>对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">join</span>(<span class="string">&#x27;contacts&#x27;</span>, function (<span class="variable">$join</span>) &#123;</span><br><span class="line">            <span class="variable">$join</span>-&gt;<span class="title function_ invoke__">on</span>(<span class="string">&#x27;users.id&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;contacts.user_id&#x27;</span>)-&gt;<span class="title function_ invoke__">orOn</span>(...);</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>如果你想要在连接中使用“where”风格的子句，可以在查询中使用<code>where</code>和<code>orWhere</code>方法。这些方法将会将列和值进行比较而不是列和列进行比较：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">join</span>(<span class="string">&#x27;contacts&#x27;</span>, function (<span class="variable">$join</span>) &#123;</span><br><span class="line">            <span class="variable">$join</span>-&gt;<span class="title function_ invoke__">on</span>(<span class="string">&#x27;users.id&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;contacts.user_id&#x27;</span>)</span><br><span class="line">                 -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;contacts.user_id&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">5</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-2-5-联合（Union）"><a href="#7-2-5-联合（Union）" class="headerlink" title="7.2.5 联合（Union）"></a>7.2.5 联合（Union）</h3><p>查询构建器还提供了一条“联合”两个查询的快捷方式.</p>
<p>例如：你要创建一个独立的查询，然后使用<code>union</code>方法将其和第二个查询进行联合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$first</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">whereNull</span>(<span class="string">&#x27;first_name&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">whereNull</span>(<span class="string">&#x27;last_name&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">union</span>(<span class="variable">$first</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p><code>unionAll</code>方法也是有效的，并且和<code>union</code>有同样的使用方法。</p>
<hr>
<h3 id="7-2-6-Where子句"><a href="#7-2-6-Where子句" class="headerlink" title="7.2.6 Where子句"></a>7.2.6 Where子句</h3><h4 id="7-2-6-1-简单where子句"><a href="#7-2-6-1-简单where子句" class="headerlink" title="7.2.6.1 简单where子句"></a>7.2.6.1 简单where子句</h4><p>使用查询构建器上的<code>where</code>方法可以添加<code>where</code>子句到查询中，调用<code>where</code>最基本的方法需要三个参数，第一个参数是列名，第二个参数是一个数据库系统支持的任意操作符，第三个参数是该列要比较的值。</p>
<p>例如，下面是一个验证<code>votes</code>列的值是否等于100的查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="number">100</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>为了方便，如果你只是简单比较列值和给定数值是否相等，可以将数值直接作为<code>where</code>方法的第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="number">100</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>当然，你可以使用其它操作符来编写<code>where</code>子句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="string">&#x27;&gt;=&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="string">&#x27;&lt;&gt;&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;T%&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>


<h4 id="7-2-6-2-or"><a href="#7-2-6-2-or" class="headerlink" title="7.2.6.2 or"></a>7.2.6.2 or</h4><p>你可以通过方法链将多个<code>where</code>约束链接到一起，也可以添加<code>or</code>子句到查询，<code>orWhere</code>方法和<code>where</code>方法接收参数一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">orWhere</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;John&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h4 id="7-2-6-3-更多Where子句"><a href="#7-2-6-3-更多Where子句" class="headerlink" title="7.2.6.3 更多Where子句"></a>7.2.6.3 更多Where子句</h4><ul>
<li><p><strong>whereBetween</strong></p>
<p>  <code>whereBetween</code>方法验证列值是否在给定值之间：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">whereBetween</span>(<span class="string">&#x27;votes&#x27;</span>, [<span class="number">1</span>, <span class="number">100</span>])-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>whereNotBetween</strong></p>
<p>  <code>whereNotBetween</code>方法验证列值不在给定值之间：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">whereNotBetween</span>(<span class="string">&#x27;votes&#x27;</span>, [<span class="number">1</span>, <span class="number">100</span>])</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>whereIn&#x2F;whereNotIn</strong></p>
<p>  <code>whereIn</code>方法验证给定列的值是否在给定数组中：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">whereIn</span>(<span class="string">&#x27;id&#x27;</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>  <code>whereNotIn</code>方法验证给定列的值不在给定数组中：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">whereNotIn</span>(<span class="string">&#x27;id&#x27;</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>whereNull&#x2F;whereNotNull</strong></p>
<p>  <code>whereNull</code>方法验证给定列的值为NULL：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">whereNull</span>(<span class="string">&#x27;updated_at&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>  <code>whereNotNull</code>方法验证给定列的值不是NULL：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">whereNotNull</span>(<span class="string">&#x27;updated_at&#x27;</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-2-6-4-高级Where子句"><a href="#7-2-6-4-高级Where子句" class="headerlink" title="7.2.6.4 高级Where子句"></a>7.2.6.4 高级Where子句</h4><ul>
<li><p><strong>参数分组</strong></p>
<p>  有时候你需要创建更加高级的<code>where</code>子句,比如<code>where exists</code>或者嵌套的参数分组。Laravel查询构建器也可以处理这些。作为开始，让我们看一个在括号中进行分组约束的例子：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;John&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">orWhere</span>(function (<span class="variable">$query</span>) &#123;</span><br><span class="line">                <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">                      -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;&lt;&gt;&#x27;</span>, <span class="string">&#x27;Admin&#x27;</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>  正如你所看到的，传递闭包到<code>orWhere</code>方法构造查询构建器来开始一个约束分组，该闭包将会获取一个用于设置括号中包含的约束的查询构建器实例。上述语句等价于下面的SQL：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> users where name = <span class="string">&#x27;John&#x27;</span> <span class="keyword">or</span> (votes &gt; <span class="number">100</span> <span class="keyword">and</span> title &lt;&gt; <span class="string">&#x27;Admin&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>exists语句</strong></p>
<p>  <code>whereExists</code>方法允许你编写<code>where exist</code>SQL子句，<code>whereExists</code>方法接收一个闭包参数，该闭包获取一个查询构建器实例从而允许你定义放置在<code>exists</code>子句中的查询：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">whereExists</span>(function (<span class="variable">$query</span>) &#123;</span><br><span class="line">                <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">select</span>(DB::<span class="title function_ invoke__">raw</span>(<span class="number">1</span>))</span><br><span class="line">                      -&gt;<span class="keyword">from</span>(<span class="string">&#x27;orders&#x27;</span>)</span><br><span class="line">                      -&gt;<span class="title function_ invoke__">whereRaw</span>(<span class="string">&#x27;orders.user_id = users.id&#x27;</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p>  上述查询等价于下面的SQL语句：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> users</span><br><span class="line">where <span class="title function_ invoke__">exists</span> (</span><br><span class="line">    select <span class="number">1</span> <span class="keyword">from</span> orders where orders.user_id = users.id</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="7-2-7-排序、分组、限定"><a href="#7-2-7-排序、分组、限定" class="headerlink" title="7.2.7 排序、分组、限定"></a>7.2.7 排序、分组、限定</h3><h4 id="7-2-7-1-orderBy"><a href="#7-2-7-1-orderBy" class="headerlink" title="7.2.7.1 orderBy"></a>7.2.7.1 orderBy</h4><p><code>orderBy</code>方法允许你通过给定列对结果集进行排序，orderBy的第一个参数应该是你希望排序的列，第二个参数控制着排序的方向——<code>asc(正序)</code>或<code>desc(倒序)</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<h4 id="7-2-7-2-groupBy-having-havingRaw"><a href="#7-2-7-2-groupBy-having-havingRaw" class="headerlink" title="7.2.7.2 groupBy &#x2F; having &#x2F; havingRaw"></a>7.2.7.2 groupBy &#x2F; having &#x2F; havingRaw</h4><p><code>groupBy</code>和<code>having</code>方法用于对结果集进行分组，<code>having</code>方法和<code>where</code>方法的用法类似：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">groupBy</span>(<span class="string">&#x27;account_id&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">having</span>(<span class="string">&#x27;account_id&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>
<p><code>havingRaw</code>方法可以用于设置原生字符串作为<code>having</code>子句的值，例如，我们要找到所有售价大于<code>$2500</code>的部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;orders&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;department&#x27;</span>, DB::<span class="title function_ invoke__">raw</span>(<span class="string">&#x27;SUM(price) as total_sales&#x27;</span>))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">groupBy</span>(<span class="string">&#x27;department&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">havingRaw</span>(<span class="string">&#x27;SUM(price) &gt; 2500&#x27;</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h4 id="7-2-7-3-skip-take"><a href="#7-2-7-3-skip-take" class="headerlink" title="7.2.7.3 skip &#x2F; take"></a>7.2.7.3 skip &#x2F; take</h4><p>想要限定查询返回的结果集的数目，或者在查询中跳过给定数目的结果，可以使用<code>skip</code>和<code>take</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">skip</span>(<span class="number">10</span>)-&gt;<span class="title function_ invoke__">take</span>(<span class="number">5</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-2-8-插入（Insert）"><a href="#7-2-8-插入（Insert）" class="headerlink" title="7.2.8 插入（Insert）"></a>7.2.8 插入（Insert）</h3><p>查询构建器还提供了<code>insert</code>方法来插入记录到数据表。<code>insert</code>方法接收数组形式的列名和值进行插入操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">insert</span>(</span><br><span class="line">    [<span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;john@example.com&#x27;</span>, <span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>你甚至可以一次性通过传入多个数组来插入多条记录，每个数组代表要插入数据表的记录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">insert</span>([</span><br><span class="line">    [<span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;taylor@example.com&#x27;</span>, <span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;dayle@example.com&#x27;</span>, <span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">0</span>]</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h4 id="7-2-8-1-自增ID"><a href="#7-2-8-1-自增ID" class="headerlink" title="7.2.8.1 自增ID"></a>7.2.8.1 自增ID</h4><p>如果数据表有自增ID，使用<code>insertGetId</code>方法来插入记录将会返回ID值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">insertGetId</span>(</span><br><span class="line">    [<span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;john@example.com&#x27;</span>, <span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">0</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><em>注意：当使用<code>PostgresSQL</code>时,<code>insertGetId</code>方法默认自增列被命名为<code>id</code>，如果你想要从其他<code>序列</code>获取<code>ID</code>，可以将序列名作为第二个参数传递到<code>insertGetId</code>方法。</em></p>
<hr>
<h3 id="7-2-9-更新（Update）"><a href="#7-2-9-更新（Update）" class="headerlink" title="7.2.9 更新（Update）"></a>7.2.9 更新（Update）</h3><p>当然，除了插入记录到数据库，查询构建器还可以通过使用<code>update</code>方法更新已有记录。<code>update</code>方法和<code>insert</code>方法一样，接收列和值的键值对数组包含要更新的列，你可以通过<code>where</code>子句来对<code>update</code>查询进行约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;id&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">1</span>]);</span><br></pre></td></tr></table></figure>

<h4 id="7-2-9-1-增加-减少"><a href="#7-2-9-1-增加-减少" class="headerlink" title="7.2.9.1 增加&#x2F;减少"></a>7.2.9.1 增加&#x2F;减少</h4><p>查询构建器还提供了方便增减给定列名数值的方法。相较于编写<code>update</code>语句，这是一条捷径，提供了更好的体验和测试接口。</p>
<p>这两个方法都至少接收一个参数：需要修改的列。第二个参数是可选的，用于控制列值增加&#x2F;减少的数目。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">increment</span>(<span class="string">&#x27;votes&#x27;</span>);</span><br><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">increment</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="number">5</span>);</span><br><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">decrement</span>(<span class="string">&#x27;votes&#x27;</span>);</span><br><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">decrement</span>(<span class="string">&#x27;votes&#x27;</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<p>在操作过程中你还可以指定额外的列进行更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(&#x27;users&#x27;)-&gt;increment(&#x27;votes&#x27;, 1, [&#x27;name&#x27; =&gt; &#x27;John&#x27;]);</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="7-2-10-删除（Delete）"><a href="#7-2-10-删除（Delete）" class="headerlink" title="7.2.10 删除（Delete）"></a>7.2.10 删除（Delete）</h3><p>当然，查询构建器还可以通过<code>delete</code>方法从表中删除记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(&#x27;users&#x27;)-&gt;delete();</span><br></pre></td></tr></table></figure>
<p>在调用<code>delete</code>方法之前可以通过添加<code>where</code>子句对<code>delete</code>语句进行约束：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(&#x27;users&#x27;)-&gt;where(&#x27;votes&#x27;, &#x27;&lt;&#x27;, 100)-&gt;delete();</span><br></pre></td></tr></table></figure>
<p>如果你希望清除整张表，也就是删除所有列并将自增ID置为0，可以使用truncate方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(&#x27;users&#x27;)-&gt;truncate();</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-2-11-悲观锁"><a href="#7-2-11-悲观锁" class="headerlink" title="7.2.11 悲观锁"></a>7.2.11 悲观锁</h3><p>查询构建器还包含一些方法帮助你在<code>select</code>语句中实现<code>悲观锁</code>。可以在查询中使用<code>sharedLock</code>方法从而在运行语句时带一把<code>共享锁</code>。共享锁可以避免,被选择的行被修改直到事务提交：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(&#x27;users&#x27;)-&gt;where(&#x27;votes&#x27;, &#x27;&gt;&#x27;, 100)-&gt;sharedLock()-&gt;get();</span><br></pre></td></tr></table></figure>
<p>此外你还可以使用<code>lockForUpdate</code>方法。<code>for update</code>锁避免选择行被其它共享锁修改或删除：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::table(&#x27;users&#x27;)-&gt;where(&#x27;votes&#x27;, &#x27;&gt;&#x27;, 100)-&gt;lockForUpdate()-&gt;get();</span><br></pre></td></tr></table></figure>

<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://keleven.me/2016/07/26/fb9d8bedfd30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="K11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keleven.Me">
      <meta itemprop="description" content="千变万化的是世界">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Keleven.Me">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/26/fb9d8bedfd30/" class="post-title-link" itemprop="url">laravel 学习指南 第七章 第一节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-26 10:00:00" itemprop="dateCreated datePublished" datetime="2016-07-26T10:00:00+08:00">2016-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-01-01 21:55:11" itemprop="dateModified" datetime="2022-01-01T21:55:11+08:00">2022-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/laravel/" itemprop="url" rel="index"><span itemprop="name">laravel</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/26/fb9d8bedfd30/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/fb9d8bedfd30/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>TOC<br>{:toc}</li>
</ul>
<h2 id="7-数据库"><a href="#7-数据库" class="headerlink" title="7 数据库"></a>7 数据库</h2><h2 id="7-1-起步"><a href="#7-1-起步" class="headerlink" title="7.1 起步"></a>7.1 起步</h2><h3 id="7-1-1-简介"><a href="#7-1-1-简介" class="headerlink" title="7.1.1 简介"></a>7.1.1 简介</h3><p>Laravel 让连接多种数据库以及对数据库进行查询变得非常简单，不论使用原生 SQL、还是查询构建器，还是 Eloquent ORM。目前，Laravel 支持四种类型的数据库系统：</p>
<ul>
<li>MySQL</li>
<li>Postgres</li>
<li>SQLite</li>
<li>SQL Server</li>
</ul>
<h4 id="7-1-1-1-配置"><a href="#7-1-1-1-配置" class="headerlink" title="7.1.1.1 配置"></a>7.1.1.1 配置</h4><p>Laravel 让连接数据库和运行查询都变得非常简单。应用的数据库配置位于<code>config/database.php</code>。在该文件中你可以定义所有的数据库连接，并指定哪个连接是默认连接。该文件中提供了所有支持数据库系统的配置示例。</p>
<p>默认情况下，Laravel 示例环境配置已经为 Laravel Homestead 做好了设置，当然，你也可以按照需要为本地的数据库修改该配置。</p>
<ul>
<li><strong>读&#x2F;写连接</strong></li>
</ul>
<p>有时候你希望使用一个数据库连接做查询，另一个数据库连接做插入、更新和删除，Laravel 使得这件事情轻而易举，不管你用的是原生 SQL，还是查询构建器，还是 Eloquent ORM，合适的连接总是会被使用。</p>
<p>想要知道如何配置读&#x2F;写连接，让我们看看下面这个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;mysql&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;read&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span> =&gt; <span class="string">&#x27;192.168.1.1&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;write&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span> =&gt; <span class="string">&#x27;196.168.1.2&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span>    =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;database&#x27;</span>  =&gt; <span class="string">&#x27;database&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>  =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;charset&#x27;</span>   =&gt; <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;collation&#x27;</span> =&gt; <span class="string">&#x27;utf8_unicode_ci&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span>    =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>注意我们在配置数组中新增了两个键：read和write，这两个键都对应一个包含单个键“host”的数组，读&#x2F;写连接的其它数据库配置选项都共用 mysql 的主数组配置。</p>
<p>如果我们想要覆盖主数组中的配置，只需要将相应配置项放到<code>read</code>和<code>write</code>数组中即可。在本例中，<code>192.168.1.1</code>将被用作“读”连接，而<code>192.168.1.2</code>将被用作“写”连接。两个数据库连接的凭证（用户名&#x2F;密码）、前缀、字符集以及其它配置将会共享<code>mysql</code>数组中的设置。</p>
<hr>
<h3 id="7-1-2-运行原生-SQL-查询"><a href="#7-1-2-运行原生-SQL-查询" class="headerlink" title="7.1.2 运行原生 SQL 查询"></a>7.1.2 运行原生 SQL 查询</h3><p>配置好数据库连接后，就可以使用<code>DB门</code>面来运行查询。<code>DB门面</code>为每种查询提供了相应方法：<code>select</code>, <code>update</code>, <code>insert</code>, <code>delete</code>, 和<code>statement</code>。</p>
<h4 id="7-1-2-1-运行-Select-查询"><a href="#7-1-2-1-运行-Select-查询" class="headerlink" title="7.1.2.1 运行 Select 查询"></a>7.1.2.1 运行 Select 查询</h4><p>运行一个最基本的查询，可以使用<code>DB门面</code>的<code>select</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显示用户列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = DB::<span class="title function_ invoke__">select</span>(<span class="string">&#x27;select * from users where active = ?&#x27;</span>, [<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">view</span>(<span class="string">&#x27;user.index&#x27;</span>, [<span class="string">&#x27;users&#x27;</span> =&gt; <span class="variable">$users</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传递给<code>select</code>方法的第一个参数是原生的<code>SQL</code>语句，第二个参数需要绑定到查询的参数绑定，通常，这些都是<code>where</code>字句约束中的值。参数绑定可以避免<code>SQL</code>注入攻击。</p>
<p><code>select</code>方法以数组的形式返回结果，数组中的每一个结果都是一个PHP <code>StdClass</code>对象，从而允许你像下面这样访问结果值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$user</span>-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-1-2-2-使用命名绑定"><a href="#7-1-2-2-使用命名绑定" class="headerlink" title="7.1.2.2 使用命名绑定"></a>7.1.2.2 使用命名绑定</h4><p>除了使用?占位符来代表参数绑定外，还可以使用命名绑定来执行查询:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$results</span> = DB::<span class="title function_ invoke__">select</span>(<span class="string">&#x27;select * from users where id = :id&#x27;</span>, [<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">1</span>]);</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-3-运行插入语句"><a href="#7-1-2-3-运行插入语句" class="headerlink" title="7.1.2.3 运行插入语句"></a>7.1.2.3 运行插入语句</h4><p>使用<code>DB门面</code>的<code>insert</code>方法执行插入语句。和<code>select</code>一样，改方法将原生SQL语句作为第一个参数，将绑定作为第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$results</span> = DB::<span class="title function_ invoke__">insert</span>(<span class="string">&#x27;insert into users (id, name) values (?, ?)&#x27;</span>, [<span class="number">1</span>, <span class="string">&#x27;Dayle&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-4-运行更新语句"><a href="#7-1-2-4-运行更新语句" class="headerlink" title="7.1.2.4 运行更新语句"></a>7.1.2.4 运行更新语句</h4><p><code>update</code>方法用于更新数据库中已存在的记录，该方法返回受更新语句影响的行数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$affected</span> = DB::<span class="title function_ invoke__">update</span>(<span class="string">&#x27;update users set votes = 100 where name = ?&#x27;</span>, [<span class="string">&#x27;John&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-5-运行删除语句"><a href="#7-1-2-5-运行删除语句" class="headerlink" title="7.1.2.5 运行删除语句"></a>7.1.2.5 运行删除语句</h4><p><code>delete</code>方法用于删除数据库中已存在的记录，和<code>update</code>一样，该语句返回被删除的行数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deleted</span> = DB::<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;delete from users&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-6-运行一个通用语句"><a href="#7-1-2-6-运行一个通用语句" class="headerlink" title="7.1.2.6 运行一个通用语句"></a>7.1.2.6 运行一个通用语句</h4><p>有些数据库语句不返回任何值，对于这种类型的操作，可以使用<code>DB门面</code>的<code>statement</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">statement</span>(<span class="string">&#x27;drop table users&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-7-监听查询事件"><a href="#7-1-2-7-监听查询事件" class="headerlink" title="7.1.2.7 监听查询事件"></a>7.1.2.7 监听查询事件</h4><p>如果你想要获取应用中每次 SQL 语句的执行，可以使用<code>listen</code>方法，该方法对查询日志和调试非常有用，你可以在服务提供者中注册查询监听器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动所有应用服务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DB::<span class="title function_ invoke__">listen</span>(function(<span class="variable">$query</span>) &#123;</span><br><span class="line">            <span class="comment">// $query-&gt;sql</span></span><br><span class="line">            <span class="comment">// $query-&gt;bindings</span></span><br><span class="line">            <span class="comment">// $query-&gt;time</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册服务提供者</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-1-3-数据库事务"><a href="#7-1-3-数据库事务" class="headerlink" title="7.1.3 数据库事务"></a>7.1.3 数据库事务</h3><p>想要在一个数据库事务中运行一连串操作，可以使用<code>DB门面</code>的<code>transaction</code>方法，如果事务闭包中抛出异常，事务将会自动回滚。</p>
<p>如果闭包执行成功，事务将会自动提交。使用<code>transaction</code>方法时不需要担心手动回滚或提交：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DB::<span class="title function_ invoke__">transaction</span>(function () &#123;</span><br><span class="line">    DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">    DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;posts&#x27;</span>)-&gt;<span class="title function_ invoke__">delete</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="7-1-3-1-手动使用事务"><a href="#7-1-3-1-手动使用事务" class="headerlink" title="7.1.3.1 手动使用事务"></a>7.1.3.1 手动使用事务</h4><p>如果你想要手动开始事务从而对回滚和提交有一个完整的控制，可以使用<code>DB门面</code>的<code>beginTransaction</code>方法：</p>
<pre><code>DB::beginTransaction();
</code></pre>
<p>你可以通过<code>rollBack</code>方法回滚事务：</p>
<pre><code>DB::rollBack();
</code></pre>
<p>最后，可以通过<code>commit</code>方法提交事务：</p>
<pre><code>DB::commit();
</code></pre>
<p><em>注意：使用<code>DB门面</code>的事务方法还可以用于控制查询构建器和 <code>Eloquent ORM</code> 的事务。</em></p>
<hr>
<h3 id="7-1-4-使用多个数据库连接"><a href="#7-1-4-使用多个数据库连接" class="headerlink" title="7.1.4 使用多个数据库连接"></a>7.1.4 使用多个数据库连接</h3><p>使用多个数据库连接的时候，可以使用<code>DB门面</code>的<code>connection</code>方法访问每个连接。传递给<code>connection</code>方法的连接名对应配置文件<code>config/database.php</code>中相应的连接：</p>
<pre><code>$users = DB::connection(&#39;foo&#39;)-&gt;select(...);
</code></pre>
<p>你还可以通过连接实例上的<code>getPdo</code>方法底层原生的 PDO 实例：</p>
<pre><code>$pdo = DB::connection()-&gt;getPdo();
</code></pre>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/27/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><span class="page-number current">28</span><a class="page-number" href="/page/29/">29</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/29/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2016 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">K11</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">97k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:53</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"keleven","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js" defer></script>

</body>
</html>
